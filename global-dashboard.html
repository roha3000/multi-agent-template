<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Monitor</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --critical: #ff6b6b;
            --info: #58a6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .alert-banner.warning {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #d29922, #e8a832);
            color: #000;
        }

        .alert-banner.critical {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #f85149, #ff6b6b);
            color: #fff;
        }

        .alert-banner.emergency {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #ff0000, #cc0000);
            color: #fff;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid currentColor;
            color: inherit;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .copy-btn:hover { background: rgba(255,255,255,0.3); }

        /* Header */
        .header {
            padding: 20px 30px;
            padding-top: 80px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.disconnected { background: var(--danger); }

        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .sound-toggle input { width: 16px; height: 16px; }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Active Sessions Section */
        .section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Session Card - The Main Focus */
        .session-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .session-card.warning { border-color: var(--warning); }
        .session-card.critical { border-color: var(--danger); }
        .session-card.emergency {
            border-color: var(--critical);
            animation: pulse-border 1s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 107, 107, 0.1); }
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .session-name {
            font-size: 20px;
            font-weight: 600;
        }

        .session-path {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-top: 4px;
        }

        .session-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .session-status.ok { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .session-status.warning { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .session-status.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
        .session-status.emergency { background: rgba(255, 0, 0, 0.15); color: var(--critical); }

        /* The Big Number - Remaining Context */
        .remaining-display {
            text-align: center;
            padding: 30px 0;
        }

        .remaining-value {
            font-size: 72px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .remaining-value.ok { color: var(--success); }
        .remaining-value.warning { color: var(--warning); }
        .remaining-value.critical { color: var(--danger); }
        .remaining-value.emergency { color: var(--critical); }

        .remaining-label {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .remaining-tokens {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Progress Bar */
        .progress-container {
            margin: 24px 0;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .progress-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s, background 0.3s;
        }

        .progress-fill.ok { background: var(--success); }
        .progress-fill.warning { background: var(--warning); }
        .progress-fill.critical { background: var(--danger); }
        .progress-fill.emergency { background: var(--critical); }

        /* Threshold markers */
        .progress-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.3);
        }

        .marker::after {
            content: attr(data-label);
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Action Buttons */
        .session-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover { background: var(--border); }

        .action-btn.primary {
            background: var(--info);
            border-color: var(--info);
            color: #fff;
        }

        .action-btn.primary:hover { background: #4a8fd9; }

        .action-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff;
        }

        /* Inactive Projects - Collapsed */
        .inactive-section {
            margin-top: 32px;
        }

        .inactive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .inactive-header:hover { background: var(--bg-tertiary); }

        .inactive-list {
            display: none;
            margin-top: 8px;
        }

        .inactive-list.show { display: block; }

        .inactive-item {
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .inactive-name { color: var(--text-secondary); }
        .inactive-time { color: var(--text-secondary); font-size: 12px; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state-sub {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Session Series Panel */
        .series-panel {
            background: linear-gradient(135deg, #1a1f2e 0%, #1c2128 100%);
            border: 2px solid var(--info);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .series-title {
            font-size: 14px;
            color: var(--info);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .series-active-dot {
            width: 8px;
            height: 8px;
            background: var(--info);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .series-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .series-stat {
            text-align: center;
            padding: 12px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 8px;
        }

        .series-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .series-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .series-history {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .series-session-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 12px;
        }

        .series-session-chip.threshold { border-left: 3px solid var(--warning); }
        .series-session-chip.complete { border-left: 3px solid var(--success); }
        .series-session-chip.error { border-left: 3px solid var(--danger); }
        .series-session-chip.active { border-left: 3px solid var(--info); background: rgba(88, 166, 255, 0.15); }

        /* Execution State Panel */
        .execution-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .execution-panel {
                grid-template-columns: 1fr;
            }
        }

        .phase-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .phase-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .phase-card-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .phase-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .phase-badge.research { background: rgba(88, 166, 255, 0.2); color: var(--info); }
        .phase-badge.design { background: rgba(163, 113, 247, 0.2); color: #a371f7; }
        .phase-badge.implement { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .phase-badge.test { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .phase-badge.complete { background: rgba(63, 185, 80, 0.3); color: var(--success); }

        .phase-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: capitalize;
        }

        .phase-iteration {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Quality Scores */
        .scores-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-total {
            font-size: 36px;
            font-weight: 700;
        }

        .score-total.passing { color: var(--success); }
        .score-total.failing { color: var(--danger); }
        .score-total.close { color: var(--warning); }

        .score-threshold {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .score-criteria {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .score-criterion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .criterion-name {
            color: var(--text-secondary);
        }

        .criterion-score {
            font-weight: 600;
        }

        .criterion-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin: 0 12px;
            overflow: hidden;
        }

        .criterion-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .criterion-fill.high { background: var(--success); }
        .criterion-fill.medium { background: var(--warning); }
        .criterion-fill.low { background: var(--danger); }

        /* Todo Progress */
        .todos-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .todos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .todos-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .todos-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .todos-progress-bar {
            width: 100px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .todos-progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .todos-progress-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .todos-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-checkbox {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .todo-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .todo-checkbox.checked::after {
            content: '‚úì';
            color: #fff;
            font-size: 10px;
            font-weight: bold;
        }

        .todo-text {
            flex: 1;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
        }

        /* Phase History */
        .phase-history {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }

        .phase-history-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .phase-history-dot.passing { background: var(--success); }
        .phase-history-dot.failing { background: var(--danger); }
        .phase-history-dot.current { background: var(--info); animation: pulse-dot 1.5s infinite; }

        /* Task Action Buttons */
        .todos-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .add-task-btn, .view-backlog-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .add-task-btn {
            background: linear-gradient(135deg, var(--info), #667eea);
            color: white;
            flex: 1;
        }

        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }

        .view-backlog-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .view-backlog-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Clickable Todo Items */
        .todo-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .todo-item:hover {
            background: var(--bg-secondary);
            border-left-color: var(--info);
            transform: translateX(4px);
        }

        .todo-priority {
            font-size: 1rem;
            margin-left: 8px;
        }

        /* Backlog Panel */
        .backlog-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .backlog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .backlog-count {
            background: var(--info);
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .backlog-filters select {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .backlog-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .backlog-item {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid var(--border);
        }

        .backlog-item:hover {
            border-left-color: var(--info);
            transform: translateX(4px);
        }

        .backlog-item-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Modal */
        .task-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .task-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border);
            animation: modalSlideIn 0.2s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-modal-content h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .task-modal-content input,
        .task-modal-content select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .task-modal-content input:focus,
        .task-modal-content select:focus {
            outline: none;
            border-color: var(--info);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .modal-btn-primary, .modal-btn-secondary {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--info), #667eea);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .modal-btn-secondary:hover {
            background: var(--bg-primary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertIcon">‚ö†Ô∏è</span>
        <span id="alertMessage">Alert message here</span>
        <button class="copy-btn" onclick="copyCommand('/clear')">Copy /clear</button>
    </div>

    <!-- Header -->
    <header class="header">
        <h1>
            <span class="status-dot" id="statusDot"></span>
            Context Monitor
        </h1>
        <div class="sound-toggle">
            <input type="checkbox" id="soundEnabled" checked>
            <label for="soundEnabled">Sound Alerts</label>
        </div>
    </header>

    <div class="container">
        <!-- Session Series Panel (shown when continuous loop is active) -->
        <div class="series-panel" id="seriesPanel" style="display: none;">
            <div class="series-header">
                <div class="series-title">
                    <span class="series-active-dot"></span>
                    Continuous Loop Active
                </div>
                <span id="seriesRuntime" style="color: var(--text-secondary); font-size: 13px;">0m 0s</span>
            </div>
            <div class="series-stats">
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesCurrentSession">1</div>
                    <div class="series-stat-label">Current Session</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesCompleted">0</div>
                    <div class="series-stat-label">Completed</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesTotalTokens">0</div>
                    <div class="series-stat-label">Total Tokens</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesTotalCost">$0.00</div>
                    <div class="series-stat-label">Total Cost</div>
                </div>
            </div>
            <div class="series-history" id="seriesHistory">
                <!-- Session chips will be rendered here -->
            </div>
        </div>

        <!-- Execution State Panel -->
        <div class="execution-panel" id="executionPanel" style="display: none;">
            <!-- Current Phase -->
            <div class="phase-card">
                <div class="phase-card-header">
                    <span class="phase-card-title">Current Phase</span>
                    <span class="phase-badge" id="phaseBadge">research</span>
                </div>
                <div class="phase-name" id="phaseName">Research</div>
                <div class="phase-iteration" id="phaseIteration">Iteration 1 of 10</div>
                <div class="phase-history" id="phaseHistory">
                    <!-- Phase history dots -->
                </div>
            </div>

            <!-- Quality Scores -->
            <div class="scores-card">
                <div class="score-header">
                    <div>
                        <div class="phase-card-title">Quality Score</div>
                        <div class="score-total" id="scoreTotal">--</div>
                    </div>
                    <div class="score-threshold" id="scoreThreshold">Min: 80</div>
                </div>
                <div class="score-criteria" id="scoreCriteria">
                    <!-- Criteria bars will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Todo Progress Panel -->
        <div class="todos-panel" id="todosPanel" style="display: none;">
            <div class="todos-header">
                <span class="todos-title">Task Progress</span>
                <div class="todos-progress">
                    <div class="todos-progress-bar">
                        <div class="todos-progress-fill" id="todosProgressFill" style="width: 0%"></div>
                    </div>
                    <span class="todos-progress-text" id="todosProgressText">0/0</span>
                </div>
            </div>

            <!-- Task Actions -->
            <div class="todos-actions">
                <button class="add-task-btn" onclick="showAddTaskModal()">+ Add Task</button>
                <button class="view-backlog-btn" onclick="toggleBacklogView()">üìã View Backlog</button>
            </div>

            <div class="todos-list" id="todosList">
                <!-- Todo items will be rendered here -->
            </div>

            <!-- Backlog Panel (hidden by default) -->
            <div id="backlogPanel" class="backlog-panel" style="display: none;">
                <div class="backlog-header">
                    <span>üìã Backlog</span>
                    <span class="backlog-count" id="backlogCount">0</span>
                </div>
                <div class="backlog-filters">
                    <select id="backlogPriorityFilter" onchange="filterBacklog()">
                        <option value="">All Priorities</option>
                        <option value="critical">üî¥ Critical</option>
                        <option value="high">üü° High</option>
                        <option value="medium">üü¢ Medium</option>
                        <option value="low">‚ö™ Low</option>
                    </select>
                </div>
                <div class="backlog-list" id="backlogList">
                    <!-- Backlog items rendered here -->
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="addTaskModal" class="task-modal" style="display: none;">
            <div class="task-modal-content">
                <h3>Add New Task</h3>
                <input type="text" id="newTaskText" placeholder="Task description..." />
                <select id="newTaskPriority">
                    <option value="medium">üü¢ Medium Priority</option>
                    <option value="high">üü° High Priority</option>
                    <option value="critical">üî¥ Critical Priority</option>
                    <option value="low">‚ö™ Low Priority</option>
                </select>
                <div class="modal-actions">
                    <button class="modal-btn-primary" onclick="submitNewTask()">Add Task</button>
                    <button class="modal-btn-secondary" onclick="hideAddTaskModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="activeSessionsContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-text">No active sessions</div>
                <div class="empty-state-sub">Start a Claude Code session to begin monitoring</div>
            </div>
        </div>

        <!-- Inactive Projects (Collapsed) -->
        <div class="inactive-section" id="inactiveSection" style="display: none;">
            <div class="inactive-header" onclick="toggleInactive()">
                <span id="inactiveCount">0 inactive projects</span>
                <span id="inactiveToggle">‚ñº</span>
            </div>
            <div class="inactive-list" id="inactiveList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3033';
        let soundEnabled = true;
        let audioContext = null;
        let lastAlertLevel = null;
        let eventSource = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlertSound(frequency = 800, duration = 0.3, count = 1) {
            if (!soundEnabled) return;
            initAudio();

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                }, i * (duration * 1000 + 100));
            }
        }

        function formatTokens(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toLocaleString();
        }

        function getStatusClass(usedPercent) {
            // Based on context remaining (100 - used)
            // Thresholds: <25% remaining = emergency, <35% = critical, <50% = warning
            const remaining = 100 - usedPercent;
            if (remaining <= 25) return 'emergency';   // ‚â§25% remaining (~5k until compact)
            if (remaining <= 35) return 'critical';    // ‚â§35% remaining (~25k until compact)
            if (remaining <= 50) return 'warning';     // ‚â§50% remaining (~55k until compact)
            return 'ok';
        }

        function copyCommand(cmd) {
            navigator.clipboard.writeText(cmd);
            // Brief visual feedback
            event.target.textContent = 'Copied!';
            setTimeout(() => { event.target.textContent = `Copy ${cmd}`; }, 1000);
        }

        function toggleInactive() {
            const list = document.getElementById('inactiveList');
            const toggle = document.getElementById('inactiveToggle');
            list.classList.toggle('show');
            toggle.textContent = list.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function updateSessionSeries(series) {
            const panel = document.getElementById('seriesPanel');

            if (!series || !series.active) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            // Update stats
            document.getElementById('seriesCurrentSession').textContent = series.currentSession || 1;
            document.getElementById('seriesCompleted').textContent = series.sessions?.length || 0;
            document.getElementById('seriesTotalTokens').textContent = formatTokens(series.totalTokens || 0);
            document.getElementById('seriesTotalCost').textContent = `$${(series.totalCost || 0).toFixed(2)}`;

            // Update runtime
            if (series.startTime) {
                const runtime = Date.now() - new Date(series.startTime).getTime();
                document.getElementById('seriesRuntime').textContent = formatDuration(runtime);
            }

            // Update session history chips
            const history = document.getElementById('seriesHistory');
            if (series.sessions && series.sessions.length > 0) {
                history.innerHTML = series.sessions.map((s, i) => {
                    const chipClass = s.exitReason === 'threshold' ? 'threshold' :
                                     s.exitReason === 'complete' ? 'complete' :
                                     s.exitReason === 'error' ? 'error' : '';
                    const icon = s.exitReason === 'threshold' ? 'üîÑ' :
                                s.exitReason === 'complete' ? '‚úÖ' :
                                s.exitReason === 'error' ? '‚ùå' : 'üìù';
                    return `
                        <div class="series-session-chip ${chipClass}">
                            ${icon} Session ${s.sessionNumber}: ${s.peakContext?.toFixed(0) || 0}%
                        </div>
                    `;
                }).join('');

                // Add current session indicator
                if (series.currentSession > series.sessions.length) {
                    history.innerHTML += `
                        <div class="series-session-chip active">
                            ‚ö° Session ${series.currentSession}: Running...
                        </div>
                    `;
                }
            } else {
                history.innerHTML = `
                    <div class="series-session-chip active">
                        ‚ö° Session 1: Running...
                    </div>
                `;
            }
        }

        // Phase thresholds
        const PHASE_THRESHOLDS = {
            research: 80,
            design: 85,
            implement: 90,
            test: 90,
            complete: 100
        };

        function updateExecutionState(execState) {
            const panel = document.getElementById('executionPanel');
            const todosPanel = document.getElementById('todosPanel');

            if (!execState || (!execState.currentPhase && !execState.qualityScores && (!execState.todos || execState.todos.length === 0))) {
                panel.style.display = 'none';
                todosPanel.style.display = 'none';
                return;
            }

            // Show panels
            if (execState.currentPhase || execState.qualityScores) {
                panel.style.display = 'grid';
            }

            // Update phase info
            if (execState.currentPhase) {
                const phase = execState.currentPhase;
                const phaseBadge = document.getElementById('phaseBadge');
                const phaseName = document.getElementById('phaseName');
                const phaseIteration = document.getElementById('phaseIteration');

                phaseBadge.textContent = phase;
                phaseBadge.className = `phase-badge ${phase}`;
                phaseName.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
                phaseIteration.textContent = `Iteration ${execState.phaseIteration || 1} of 10`;
            }

            // Update quality scores
            if (execState.qualityScores) {
                const scores = execState.qualityScores;
                const scoreTotal = document.getElementById('scoreTotal');
                const scoreThreshold = document.getElementById('scoreThreshold');
                const scoreCriteria = document.getElementById('scoreCriteria');

                const total = scores.totalScore || 0;
                const threshold = PHASE_THRESHOLDS[scores.phase] || 80;

                scoreTotal.textContent = total;
                scoreTotal.className = `score-total ${total >= threshold ? 'passing' : total >= threshold - 10 ? 'close' : 'failing'}`;
                scoreThreshold.textContent = `Min: ${threshold}`;

                // Render criteria
                if (scores.scores) {
                    scoreCriteria.innerHTML = Object.entries(scores.scores).map(([name, score]) => {
                        const fillClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
                        return `
                            <div class="score-criterion">
                                <span class="criterion-name">${name}</span>
                                <div class="criterion-bar">
                                    <div class="criterion-fill ${fillClass}" style="width: ${score}%"></div>
                                </div>
                                <span class="criterion-score">${score}</span>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Update phase history
            if (execState.phaseHistory && execState.phaseHistory.length > 0) {
                const historyContainer = document.getElementById('phaseHistory');
                historyContainer.innerHTML = execState.phaseHistory.map((h, i) => {
                    const threshold = PHASE_THRESHOLDS[h.phase] || 80;
                    const isPassing = h.totalScore >= threshold;
                    const isCurrent = i === execState.phaseHistory.length - 1;
                    return `<div class="phase-history-dot ${isCurrent ? 'current' : isPassing ? 'passing' : 'failing'}" title="${h.phase}: ${h.totalScore}"></div>`;
                }).join('');
            }

            // Update todos
            if (execState.todos && execState.todos.length > 0) {
                todosPanel.style.display = 'block';

                const completed = execState.todos.filter(t => t.completed).length;
                const total = execState.todos.length;
                const percent = total > 0 ? (completed / total) * 100 : 0;

                document.getElementById('todosProgressFill').style.width = `${percent}%`;
                document.getElementById('todosProgressText').textContent = `${completed}/${total}`;

                document.getElementById('todosList').innerHTML = execState.todos.map(todo => `
                    <div class="todo-item ${todo.completed ? 'completed' : ''}"
                         onclick="toggleTask('${todo.id || ''}', ${todo.completed})"
                         title="Click to ${todo.completed ? 'reopen' : 'complete'}">
                        <div class="todo-checkbox ${todo.completed ? 'checked' : ''}"></div>
                        <span class="todo-text">${todo.text}</span>
                        ${todo.priority ? `<span class="todo-priority">${getPriorityIcon(todo.priority)}</span>` : ''}
                    </div>
                `).join('');
            } else {
                todosPanel.style.display = 'none';
            }
        }

        function updateDisplay(data) {
            const { projects, sessionSeries, executionState } = data;

            // Update session series panel
            updateSessionSeries(sessionSeries);

            // Update execution state panel
            updateExecutionState(executionState);

            if (!projects || projects.length === 0) {
                document.getElementById('activeSessionsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">No projects found</div>
                        <div class="empty-state-sub">Claude Code projects will appear here</div>
                    </div>
                `;
                return;
            }

            // Split active vs inactive
            const active = projects.filter(p => p.status === 'active');
            const inactive = projects.filter(p => p.status !== 'active');

            // Find highest alert level for banner
            let highestAlert = null;
            let highestAlertProject = null;

            // Render active sessions
            const container = document.getElementById('activeSessionsContainer');

            if (active.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí§</div>
                        <div class="empty-state-text">No active sessions</div>
                        <div class="empty-state-sub">Start a Claude Code session to begin monitoring</div>
                    </div>
                `;
            } else {
                container.innerHTML = active.map(project => {
                    const used = project.metrics?.contextPercent || 0;
                    const usedTokens = project.metrics?.contextUsed || 0;
                    // Total remaining = 100% - used%
                    // Free until auto-compact ‚âà remaining - 22.5% buffer (but shown as remaining tokens)
                    const totalRemaining = Math.max(0, 100 - used);
                    const remainingTokens = Math.max(0, 200000 - usedTokens);
                    // Tokens until auto-compact (subtracting 45k buffer)
                    const tokensUntilCompact = Math.max(0, remainingTokens - 45000);
                    const statusClass = getStatusClass(used);
                    const safetyStatus = project.safetyStatus || 'OK';

                    // Track highest alert
                    if (safetyStatus === 'EMERGENCY') {
                        highestAlert = 'EMERGENCY';
                        highestAlertProject = project;
                    } else if (safetyStatus === 'CRITICAL' && highestAlert !== 'EMERGENCY') {
                        highestAlert = 'CRITICAL';
                        highestAlertProject = project;
                    } else if (safetyStatus === 'WARNING' && !highestAlert) {
                        highestAlert = 'WARNING';
                        highestAlertProject = project;
                    }

                    return `
                        <div class="session-card ${statusClass !== 'ok' ? statusClass : ''}">
                            <div class="session-header">
                                <div>
                                    <div class="session-name">${project.name}</div>
                                    <div class="session-path">${project.path}</div>
                                </div>
                                <span class="session-status ${statusClass}">${safetyStatus}</span>
                            </div>

                            <div class="remaining-display">
                                <div class="remaining-value ${statusClass}">${totalRemaining.toFixed(0)}%</div>
                                <div class="remaining-label">context remaining</div>
                                <div class="remaining-tokens">${formatTokens(tokensUntilCompact)} until auto-compact</div>
                            </div>

                            <div class="progress-container">
                                <div class="progress-labels">
                                    <span>Used: ${used.toFixed(1)}%</span>
                                    <span>Auto-compact: 77.5%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill ${statusClass}" style="width: ${Math.min(used, 100)}%"></div>
                                    <div class="progress-markers">
                                        <div class="marker" style="left: 50%;" data-label="50%"></div>
                                        <div class="marker" style="left: 65%;" data-label="65%"></div>
                                        <div class="marker" style="left: 75%;" data-label="75%"></div>
                                        <div class="marker" style="left: 77.5%; background: var(--critical);" data-label="‚ö°"></div>
                                    </div>
                                </div>
                            </div>

                            ${statusClass !== 'ok' ? `
                                <div class="session-actions">
                                    <button class="action-btn ${statusClass === 'emergency' ? 'danger' : 'primary'}"
                                            onclick="copyCommand('/clear')">
                                        Copy /clear
                                    </button>
                                    <button class="action-btn" onclick="copyCommand('/session-init')">
                                        Copy /session-init
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            // Update alert banner
            const banner = document.getElementById('alertBanner');
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = document.getElementById('alertIcon');

            if (highestAlert === 'EMERGENCY') {
                banner.className = 'alert-banner emergency';
                alertIcon.textContent = 'üö®';
                alertMessage.textContent = `${highestAlertProject.name}: Only ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining - Run /clear NOW!`;
                if (lastAlertLevel !== 'EMERGENCY') {
                    playAlertSound(1000, 0.2, 5);
                    showNotification('EMERGENCY', `Only ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% context remaining!`);
                }
                lastAlertLevel = 'EMERGENCY';
            } else if (highestAlert === 'CRITICAL') {
                banner.className = 'alert-banner critical';
                alertIcon.textContent = '‚ö†Ô∏è';
                alertMessage.textContent = `${highestAlertProject.name}: ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining - Clear soon`;
                if (lastAlertLevel !== 'CRITICAL' && lastAlertLevel !== 'EMERGENCY') {
                    playAlertSound(800, 0.3, 3);
                    showNotification('Critical', `${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% context remaining`);
                }
                lastAlertLevel = 'CRITICAL';
            } else if (highestAlert === 'WARNING') {
                banner.className = 'alert-banner warning';
                alertIcon.textContent = '‚ö°';
                alertMessage.textContent = `${highestAlertProject.name}: ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining`;
                if (!lastAlertLevel) {
                    playAlertSound(600, 0.2, 2);
                }
                lastAlertLevel = 'WARNING';
            } else {
                banner.className = 'alert-banner';
                lastAlertLevel = null;
            }

            // Update inactive section
            const inactiveSection = document.getElementById('inactiveSection');
            const inactiveList = document.getElementById('inactiveList');
            const inactiveCount = document.getElementById('inactiveCount');

            if (inactive.length > 0) {
                inactiveSection.style.display = 'block';
                inactiveCount.textContent = `${inactive.length} inactive project${inactive.length > 1 ? 's' : ''}`;
                inactiveList.innerHTML = inactive.map(p => `
                    <div class="inactive-item">
                        <span class="inactive-name">${p.name}</span>
                        <span class="inactive-time">${timeAgo(p.metrics?.lastUpdate)}</span>
                    </div>
                `).join('');
            } else {
                inactiveSection.style.display = 'none';
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`Claude: ${title}`, { body });
            }
        }

        function connect() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            eventSource = new EventSource(`${API_URL}/api/events`);

            eventSource.onopen = () => {
                document.getElementById('statusDot').classList.remove('disconnected');
                console.log('Connected to global tracker');
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            eventSource.onerror = () => {
                document.getElementById('statusDot').classList.add('disconnected');
                eventSource.close();
                setTimeout(connect, 3000);
            };
        }

        // Sound toggle
        document.getElementById('soundEnabled').addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
        });

        // ============================================================
        // Task Management Functions
        // ============================================================

        let backlogData = [];
        let backlogVisible = false;

        // Show add task modal
        function showAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'flex';
            document.getElementById('newTaskText').focus();
        }

        // Hide add task modal
        function hideAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
            document.getElementById('newTaskText').value = '';
            document.getElementById('newTaskPriority').value = 'medium';
        }

        // Submit new task
        async function submitNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            const priority = document.getElementById('newTaskPriority').value;

            if (!text) {
                showToast('Please enter a task description', 'error');
                return;
            }

            // Add priority emoji to text
            const priorityEmoji = {
                'critical': 'üî¥',
                'high': 'üü°',
                'medium': 'üü¢',
                'low': '‚ö™'
            };

            const taskText = `${priorityEmoji[priority] || ''} ${text}`;

            try {
                const response = await fetch(`${API_URL}/api/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: taskText, completed: false })
                });

                if (response.ok) {
                    showToast('Task added successfully', 'success');
                    hideAddTaskModal();
                    // Backlog will be refreshed by SSE
                } else {
                    showToast('Failed to add task', 'error');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                showToast('Error adding task', 'error');
            }
        }

        // Toggle backlog view
        function toggleBacklogView() {
            const panel = document.getElementById('backlogPanel');
            backlogVisible = !backlogVisible;

            if (backlogVisible) {
                panel.style.display = 'block';
                loadBacklog();
            } else {
                panel.style.display = 'none';
            }
        }

        // Load backlog from API
        async function loadBacklog() {
            try {
                const response = await fetch(`${API_URL}/api/todos/backlog`);
                if (response.ok) {
                    const result = await response.json();
                    backlogData = result.tasks || result || [];
                    renderBacklog();
                }
            } catch (error) {
                console.error('Error loading backlog:', error);
            }
        }

        // Filter backlog by priority
        function filterBacklog() {
            renderBacklog();
        }

        // Render backlog items
        function renderBacklog() {
            const filter = document.getElementById('backlogPriorityFilter').value;
            const list = document.getElementById('backlogList');
            const count = document.getElementById('backlogCount');

            let filtered = backlogData;
            if (filter) {
                filtered = backlogData.filter(task => task.priority === filter);
            }

            count.textContent = filtered.length;

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No backlog items</div>';
                return;
            }

            list.innerHTML = filtered.map(task => `
                <div class="backlog-item" onclick="activateTask('${task.id}')" title="Click to activate">
                    <span class="backlog-item-text">${task.text}</span>
                    ${task.priority ? `<span class="todo-priority">${getPriorityIcon(task.priority)}</span>` : ''}
                </div>
            `).join('');
        }

        // Get priority icon
        function getPriorityIcon(priority) {
            const icons = {
                'critical': 'üî¥',
                'high': 'üü°',
                'medium': 'üü¢',
                'low': '‚ö™'
            };
            return icons[priority] || '';
        }

        // Activate a backlog task (move to in-flight)
        async function activateTask(taskId) {
            try {
                const response = await fetch(`${API_URL}/api/todos/${taskId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: false })
                });

                if (response.ok) {
                    showToast('Task activated', 'success');
                    loadBacklog(); // Refresh backlog
                }
            } catch (error) {
                console.error('Error activating task:', error);
            }
        }

        // Toggle task completion status
        async function toggleTask(taskId, currentStatus) {
            try {
                const response = await fetch(`${API_URL}/api/todos/${taskId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: !currentStatus })
                });

                if (response.ok) {
                    showToast(currentStatus ? 'Task reopened' : 'Task completed', 'success');
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                showToast('Error updating task', 'error');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;

            try {
                const response = await fetch(`${API_URL}/api/todos/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Task deleted', 'success');
                    loadBacklog(); // Refresh backlog if visible
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Error deleting task', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to close modal
            if (e.key === 'Escape') {
                hideAddTaskModal();
            }
            // Ctrl+K to open add task modal
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                showAddTaskModal();
            }
            // Enter to submit task when modal is open
            if (e.key === 'Enter' && document.getElementById('addTaskModal').style.display === 'flex') {
                submitNewTask();
            }
        });

        // Initial connection
        connect();
    </script>
</body>
</html>
