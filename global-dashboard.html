<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --critical: #ff6b6b;
            --info: #58a6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .alert-banner.warning {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #d29922, #e8a832);
            color: #000;
        }

        .alert-banner.critical {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #f85149, #ff6b6b);
            color: #fff;
        }

        .alert-banner.emergency {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            background: linear-gradient(90deg, #ff0000, #cc0000);
            color: #fff;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid currentColor;
            color: inherit;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .copy-btn:hover { background: rgba(255,255,255,0.3); }

        /* Header */
        .header {
            padding: 20px 30px;
            padding-top: 80px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.disconnected { background: var(--danger); }

        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .sound-toggle input { width: 16px; height: 16px; }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Active Sessions Section */
        .section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Session Card - The Main Focus */
        .session-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .session-card.warning { border-color: var(--warning); }
        .session-card.critical { border-color: var(--danger); }
        .session-card.emergency {
            border-color: var(--critical);
            animation: pulse-border 1s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 107, 107, 0.1); }
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .session-name {
            font-size: 20px;
            font-weight: 600;
        }

        .session-path {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-top: 4px;
        }

        .session-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .session-status.ok { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .session-status.warning { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .session-status.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
        .session-status.emergency { background: rgba(255, 0, 0, 0.15); color: var(--critical); }

        /* The Big Number - Remaining Context */
        .remaining-display {
            text-align: center;
            padding: 30px 0;
        }

        .remaining-value {
            font-size: 72px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .remaining-value.ok { color: var(--success); }
        .remaining-value.warning { color: var(--warning); }
        .remaining-value.critical { color: var(--danger); }
        .remaining-value.emergency { color: var(--critical); }

        .remaining-label {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .remaining-tokens {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Progress Bar */
        .progress-container {
            margin: 24px 0;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .progress-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s, background 0.3s;
        }

        .progress-fill.ok { background: var(--success); }
        .progress-fill.warning { background: var(--warning); }
        .progress-fill.critical { background: var(--danger); }
        .progress-fill.emergency { background: var(--critical); }

        /* Threshold markers */
        .progress-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.3);
        }

        .marker::after {
            content: attr(data-label);
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Action Buttons */
        .session-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover { background: var(--border); }

        .action-btn.primary {
            background: var(--info);
            border-color: var(--info);
            color: #fff;
        }

        .action-btn.primary:hover { background: #4a8fd9; }

        .action-btn.view-details {
            background: transparent;
            border-color: var(--info);
            color: var(--info);
        }

        .action-btn.view-details:hover {
            background: var(--info);
            color: #fff;
        }

        .action-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff;
        }

        /* Inactive Projects - Collapsed */
        .inactive-section {
            margin-top: 32px;
        }

        .inactive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .inactive-header:hover { background: var(--bg-tertiary); }

        .inactive-list {
            display: none;
            margin-top: 8px;
        }

        .inactive-list.show { display: block; }

        .inactive-item {
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .inactive-name { color: var(--text-secondary); }
        .inactive-time { color: var(--text-secondary); font-size: 12px; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state-sub {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Session Series Panel */
        .series-panel {
            background: linear-gradient(135deg, #1a1f2e 0%, #1c2128 100%);
            border: 2px solid var(--info);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .series-title {
            font-size: 14px;
            color: var(--info);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .series-active-dot {
            width: 8px;
            height: 8px;
            background: var(--info);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .series-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .series-stat {
            text-align: center;
            padding: 12px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 8px;
        }

        .series-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .series-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .series-history {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .series-session-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 12px;
        }

        .series-session-chip.threshold { border-left: 3px solid var(--warning); }
        .series-session-chip.complete { border-left: 3px solid var(--success); }
        .series-session-chip.error { border-left: 3px solid var(--danger); }
        .series-session-chip.active { border-left: 3px solid var(--info); background: rgba(88, 166, 255, 0.15); }

        /* Execution State Panel */
        .execution-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .execution-panel {
                grid-template-columns: 1fr;
            }
        }

        .phase-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .phase-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .phase-card-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .phase-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .phase-badge.research { background: rgba(88, 166, 255, 0.2); color: var(--info); }
        .phase-badge.design { background: rgba(163, 113, 247, 0.2); color: #a371f7; }
        .phase-badge.implement { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .phase-badge.test { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .phase-badge.complete { background: rgba(63, 185, 80, 0.3); color: var(--success); }

        .phase-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: capitalize;
        }

        .phase-iteration {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Quality Scores */
        .scores-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-total {
            font-size: 36px;
            font-weight: 700;
        }

        .score-total.passing { color: var(--success); }
        .score-total.failing { color: var(--danger); }
        .score-total.close { color: var(--warning); }

        .score-threshold {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .score-criteria {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .score-criterion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .criterion-name {
            color: var(--text-secondary);
        }

        .criterion-score {
            font-weight: 600;
        }

        .criterion-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin: 0 12px;
            overflow: hidden;
        }

        .criterion-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .criterion-fill.high { background: var(--success); }
        .criterion-fill.medium { background: var(--warning); }
        .criterion-fill.low { background: var(--danger); }

        /* Todo Progress */
        .todos-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .todos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .todos-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .todos-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .todos-progress-bar {
            width: 100px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .todos-progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .todos-progress-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .todos-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-checkbox {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .todo-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .todo-checkbox.checked::after {
            content: 'âœ“';
            color: #fff;
            font-size: 10px;
            font-weight: bold;
        }

        .todo-text {
            flex: 1;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
        }

        /* Backlog Tasks Panel */
        .backlog-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .backlog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .backlog-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .backlog-stats {
            display: flex;
            gap: 12px;
        }

        .backlog-stat {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .backlog-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .backlog-task {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--border);
        }

        .backlog-task.in_progress {
            border-left-color: var(--info);
            background: rgba(88, 166, 255, 0.1);
        }

        .backlog-task.ready {
            border-left-color: var(--success);
        }

        .backlog-task-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .backlog-task.in_progress .backlog-task-status {
            background: var(--info);
            animation: pulse-dot 1.5s infinite;
        }

        .backlog-task.ready .backlog-task-status {
            background: var(--success);
        }

        .backlog-task-info {
            flex: 1;
            min-width: 0;
        }

        .backlog-task-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .backlog-task-phase {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .backlog-task-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .backlog-task.in_progress .backlog-task-badge {
            background: var(--info);
            color: #000;
        }

        .backlog-task.ready .backlog-task-badge {
            background: rgba(63, 185, 80, 0.2);
            color: var(--success);
        }

        /* Phase History */
        .phase-history {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }

        .phase-history-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .phase-history-dot.passing { background: var(--success); }
        .phase-history-dot.failing { background: var(--danger); }
        .phase-history-dot.current { background: var(--info); animation: pulse-dot 1.5s infinite; }

        /* ========== COMPETITIVE PLANNING PANEL ========== */
        .planning-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .planning-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .planning-title-icon {
            font-size: 16px;
        }

        .planning-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 900px) {
            .planning-cards {
                grid-template-columns: 1fr;
            }
        }

        .plan-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .plan-card:hover {
            border-color: var(--info);
            transform: translateY(-2px);
        }

        .plan-card.winner {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(63, 185, 80, 0.2);
        }

        .plan-card.winner::before {
            content: 'ðŸ‘‘ WINNER';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .plan-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .plan-strategy {
            font-size: 14px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .plan-strategy.conservative { color: var(--info); }
        .plan-strategy.balanced { color: #a371f7; }
        .plan-strategy.aggressive { color: var(--warning); }

        .plan-score {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .plan-criteria {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-criterion {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        .plan-criterion-name {
            width: 80px;
            color: var(--text-secondary);
        }

        .plan-criterion-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }

        .plan-criterion-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .plan-criterion-fill.high { background: var(--success); }
        .plan-criterion-fill.medium { background: var(--warning); }
        .plan-criterion-fill.low { background: var(--danger); }

        .plan-criterion-value {
            width: 24px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ========== CONFIDENCE GAUGE ========== */
        .confidence-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .confidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .confidence-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .confidence-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-status.healthy { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .confidence-status.warning { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .confidence-status.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
        .confidence-status.emergency { background: rgba(255, 0, 0, 0.15); color: var(--critical); }

        .confidence-content {
            display: grid;
            grid-template-columns: 160px 1fr 200px;
            gap: 24px;
            align-items: center;
        }

        @media (max-width: 900px) {
            .confidence-content {
                grid-template-columns: 1fr;
                justify-items: center;
            }
        }

        .confidence-gauge {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .confidence-gauge svg {
            transform: rotate(-90deg);
        }

        .confidence-gauge-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 12;
        }

        .confidence-gauge-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
        }

        .confidence-gauge-fill.healthy { stroke: var(--success); }
        .confidence-gauge-fill.warning { stroke: var(--warning); }
        .confidence-gauge-fill.critical { stroke: var(--danger); }
        .confidence-gauge-fill.emergency { stroke: var(--critical); }

        .confidence-gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .confidence-gauge-number {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }

        .confidence-gauge-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .confidence-signals {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .confidence-signal {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .signal-icon {
            width: 24px;
            text-align: center;
            font-size: 14px;
        }

        .signal-info {
            flex: 1;
        }

        .signal-name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .signal-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .signal-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .signal-value {
            font-size: 12px;
            font-weight: 600;
            width: 32px;
            text-align: right;
        }

        .confidence-trend {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            height: 120px;
        }

        .trend-title {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .trend-chart {
            width: 100%;
            height: 80px;
        }

        .trend-line {
            fill: none;
            stroke: var(--info);
            stroke-width: 2;
        }

        .trend-area {
            fill: url(#trendGradient);
            opacity: 0.3;
        }

        .trend-point {
            fill: var(--info);
        }

        /* ========== COMPLEXITY INDICATORS ========== */
        .complexity-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: help;
            position: relative;
        }

        .complexity-badge.fast-path {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        .complexity-badge.standard {
            background: rgba(88, 166, 255, 0.15);
            color: var(--info);
        }

        .complexity-badge.competitive {
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
        }

        .complexity-stars {
            display: flex;
            gap: 2px;
        }

        .complexity-star {
            font-size: 10px;
        }

        .complexity-star.filled { color: var(--warning); }
        .complexity-star.empty { color: var(--border); }

        .complexity-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .complexity-badge:hover .complexity-tooltip {
            display: block;
        }

        .complexity-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }

        .tooltip-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .tooltip-dimensions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tooltip-dimension {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .tooltip-dim-name {
            color: var(--text-secondary);
        }

        .tooltip-dim-value {
            font-weight: 600;
        }

        /* Task card complexity integration */
        .task-complexity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        /* ======================================
           KEYBOARD SHORTCUTS MODAL - Phase 4 Polish
           ====================================== */

        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .shortcuts-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .shortcuts-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .shortcuts-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .shortcuts-close:hover {
            color: var(--text-primary);
        }

        .shortcuts-body {
            padding: 20px 24px;
        }

        .shortcuts-section {
            margin-bottom: 24px;
        }

        .shortcuts-section:last-child {
            margin-bottom: 0;
        }

        .shortcuts-section h3 {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .shortcut-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        .shortcut-row span {
            color: var(--text-secondary);
            font-size: 14px;
        }

        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            color: var(--text-primary);
            box-shadow: 0 2px 0 var(--border);
        }

        .shortcuts-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Keyboard focus ring for session cards */
        .session-card.keyboard-focus {
            outline: 2px solid var(--info);
            outline-offset: 2px;
        }

        .session-card:focus-visible {
            outline: 2px solid var(--info);
            outline-offset: 2px;
        }

        /* ======================================
           COMMAND CENTER - Level 1 UI Components
           ====================================== */

        /* Global Metrics Bar */
        .global-metrics-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            padding: 20px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            text-align: center;
        }

        .metric-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .metric-card-value.with-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .metric-trend {
            font-size: 14px;
            font-weight: 600;
        }

        .metric-trend.up { color: var(--danger); }
        .metric-trend.down { color: var(--success); }

        .metric-card-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .metric-card.alert .metric-card-value {
            color: var(--danger);
        }

        .alert-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            padding: 0 8px;
        }

        /* Usage Limits Panel */
        .usage-limits-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px 30px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .usage-limit-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
        }

        .usage-limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .usage-limit-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .usage-limit-percent {
            font-size: 18px;
            font-weight: 700;
        }

        .usage-limit-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .usage-limit-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .usage-limit-fill.safe { background: var(--success); }
        .usage-limit-fill.caution { background: var(--warning); }
        .usage-limit-fill.warning { background: #f0883e; }
        .usage-limit-fill.critical { background: var(--danger); }

        .usage-limit-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .usage-limit-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .usage-limit-row .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .usage-pace {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .pace-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pace-indicator.safe { background: var(--success); }
        .pace-indicator.warning { background: var(--warning); }
        .pace-indicator.critical { background: var(--danger); }

        /* Recent Completions Table */
        .recent-completions-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 24px;
            overflow: hidden;
        }

        .recent-completions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .recent-completions-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-completions-link {
            font-size: 13px;
            color: var(--info);
            text-decoration: none;
            cursor: pointer;
        }

        .recent-completions-link:hover {
            text-decoration: underline;
        }

        .recent-completions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recent-completions-table th,
        .recent-completions-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .recent-completions-table th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }

        .recent-completions-table td {
            font-size: 13px;
        }

        .recent-completions-table tr:last-child td {
            border-bottom: none;
        }

        .recent-completions-table tr:hover {
            background: var(--bg-tertiary);
        }

        .completion-score {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 24px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .completion-score.high {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        .completion-score.medium {
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
        }

        .completion-score.low {
            background: rgba(248, 81, 73, 0.15);
            color: var(--danger);
        }

        .empty-completions {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Usage Limit Alert Banner */
        .usage-alert-banner {
            display: none;
            padding: 12px 20px;
            background: linear-gradient(90deg, var(--danger), #ff6b6b);
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .usage-alert-banner.visible {
            display: block;
        }

        /* ======================================
           RESPONSIVE DESIGN - Phase 4 Polish
           ====================================== */

        /* Session Cards Grid Layout */
        #activeSessionsContainer {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        #activeSessionsContainer .empty-state {
            grid-column: 1 / -1;
        }

        /* Large tablets / small laptops (1200px) */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 20px;
            }

            .series-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            #activeSessionsContainer {
                grid-template-columns: repeat(2, 1fr);
            }

            .global-metrics-bar {
                grid-template-columns: repeat(3, 1fr);
                padding: 16px 20px;
            }

            .usage-limits-panel {
                padding: 16px 20px;
            }
        }

        /* Tablets (900px) - enhance existing */
        @media (max-width: 900px) {
            .header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
                padding: 16px;
                padding-top: 70px;
            }

            .header h1 {
                font-size: 18px;
            }

            .container {
                padding: 16px;
            }

            .series-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            #activeSessionsContainer {
                grid-template-columns: 1fr;
            }

            .session-card {
                padding: 16px;
            }

            .global-metrics-bar {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                padding: 16px;
            }

            .metric-card-value {
                font-size: 24px;
            }

            .usage-limits-panel {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 16px;
            }
        }

        /* Small tablets (768px) - enhance existing */
        @media (max-width: 768px) {
            .alert-banner {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }

            .copy-btn {
                padding: 8px 20px;
                min-height: 44px;
            }

            .session-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                min-height: 44px;
            }

            .global-metrics-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .recent-completions-table th:nth-child(4),
            .recent-completions-table td:nth-child(4) {
                display: none;
            }
        }

        /* Mobile phones (480px) */
        @media (max-width: 480px) {
            .header {
                padding: 12px;
                padding-top: 60px;
            }

            .header h1 {
                font-size: 16px;
            }

            .container {
                padding: 12px;
            }

            .section-title {
                font-size: 12px;
            }

            .series-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .series-stat {
                padding: 8px;
            }

            .series-stat-value {
                font-size: 18px;
            }

            .series-stat-label {
                font-size: 10px;
            }

            .global-metrics-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 12px;
            }

            .metric-card {
                padding: 12px;
            }

            .metric-card-value {
                font-size: 20px;
            }

            .metric-card-label {
                font-size: 10px;
            }

            .usage-limits-panel {
                padding: 12px;
                gap: 8px;
            }

            .usage-limit-card {
                padding: 12px;
            }

            .recent-completions-table th:nth-child(3),
            .recent-completions-table td:nth-child(3),
            .recent-completions-table th:nth-child(4),
            .recent-completions-table td:nth-child(4) {
                display: none;
            }

            .session-card {
                padding: 12px;
                border-radius: 12px;
            }

            .session-name {
                font-size: 14px;
            }

            .remaining-value {
                font-size: 32px;
            }

            .remaining-label {
                font-size: 11px;
            }

            .progress-labels {
                font-size: 10px;
            }

            .phase-card, .scores-card {
                padding: 12px;
            }

            .todos-panel, .backlog-panel {
                padding: 12px;
            }

            .confidence-gauge svg {
                width: 100px;
                height: 100px;
            }

            .confidence-signals {
                gap: 8px;
            }

            .planning-cards {
                gap: 12px;
            }

            .plan-card {
                padding: 12px;
            }

            /* Touch-friendly targets */
            button, .action-btn, .copy-btn, .control-btn {
                min-height: 44px;
                min-width: 44px;
            }

            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            /* Improve tap targets for interactive elements */
            .inactive-header {
                min-height: 44px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertIcon">âš ï¸</span>
        <span id="alertMessage">Alert message here</span>
        <button class="copy-btn" onclick="copyCommand('/clear')">Copy /clear</button>
    </div>

    <!-- Header -->
    <header class="header">
        <h1>
            <span class="status-dot" id="statusDot"></span>
            COMMAND CENTER
        </h1>
        <div class="sound-toggle">
            <input type="checkbox" id="soundEnabled" checked>
            <label for="soundEnabled">Sound Alerts</label>
        </div>
    </header>

    <!-- Usage Limit Alert Banner -->
    <div class="usage-alert-banner" id="usageAlertBanner">
        âš ï¸ Usage limit approaching 90% - Consider pausing sessions
    </div>

    <!-- Global Metrics Bar (5 Stat Cards) -->
    <div class="global-metrics-bar" id="globalMetricsBar">
        <div class="metric-card">
            <div class="metric-card-value" id="metricActiveSessions">0</div>
            <div class="metric-card-label">Active Sessions</div>
        </div>
        <div class="metric-card">
            <div class="metric-card-value" id="metricTasksDone">0 / 0</div>
            <div class="metric-card-label">Tasks Done Today</div>
        </div>
        <div class="metric-card">
            <div class="metric-card-value" id="metricHealthScore">--%</div>
            <div class="metric-card-label">Avg Health Score</div>
        </div>
        <div class="metric-card">
            <div class="metric-card-value with-trend" id="metricCostToday">
                <span>$0.00</span>
            </div>
            <div class="metric-card-label">Cost Today</div>
        </div>
        <div class="metric-card" id="metricAlertsCard">
            <div class="metric-card-value" id="metricAlerts">0</div>
            <div class="metric-card-label">Active Alerts</div>
        </div>
    </div>

    <!-- Usage Limits Panel (5h/Daily/Weekly) -->
    <div class="usage-limits-panel" id="usageLimitsPanel">
        <!-- 5-Hour Window -->
        <div class="usage-limit-card" id="usageLimit5h">
            <div class="usage-limit-header">
                <span class="usage-limit-title">5-Hour Window</span>
                <span class="usage-limit-percent safe" id="usage5hPercent">0%</span>
            </div>
            <div class="usage-limit-bar">
                <div class="usage-limit-fill safe" id="usage5hFill" style="width: 0%"></div>
            </div>
            <div class="usage-limit-details">
                <div class="usage-limit-row">
                    <span>Used</span>
                    <span class="value" id="usage5hUsed">0 / 0 messages</span>
                </div>
                <div class="usage-limit-row">
                    <span>Resets in</span>
                    <span class="value" id="usage5hReset">--</span>
                </div>
            </div>
            <div class="usage-pace" id="usage5hPace">
                <span class="pace-indicator safe"></span>
                <span>Pace: -- msg/hr</span>
            </div>
        </div>

        <!-- Daily Limit -->
        <div class="usage-limit-card" id="usageLimitDaily">
            <div class="usage-limit-header">
                <span class="usage-limit-title">Daily Limit</span>
                <span class="usage-limit-percent safe" id="usageDailyPercent">0%</span>
            </div>
            <div class="usage-limit-bar">
                <div class="usage-limit-fill safe" id="usageDailyFill" style="width: 0%"></div>
            </div>
            <div class="usage-limit-details">
                <div class="usage-limit-row">
                    <span>Used</span>
                    <span class="value" id="usageDailyUsed">0 / 0 messages</span>
                </div>
                <div class="usage-limit-row">
                    <span>Resets in</span>
                    <span class="value" id="usageDailyReset">--</span>
                </div>
                <div class="usage-limit-row">
                    <span>Projected</span>
                    <span class="value" id="usageDailyProjected">--</span>
                </div>
            </div>
        </div>

        <!-- Weekly Limit -->
        <div class="usage-limit-card" id="usageLimitWeekly">
            <div class="usage-limit-header">
                <span class="usage-limit-title">Weekly Limit</span>
                <span class="usage-limit-percent safe" id="usageWeeklyPercent">0%</span>
            </div>
            <div class="usage-limit-bar">
                <div class="usage-limit-fill safe" id="usageWeeklyFill" style="width: 0%"></div>
            </div>
            <div class="usage-limit-details">
                <div class="usage-limit-row">
                    <span>Used</span>
                    <span class="value" id="usageWeeklyUsed">0 / 0</span>
                </div>
                <div class="usage-limit-row">
                    <span>Resets</span>
                    <span class="value" id="usageWeeklyReset">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Session Series Panel (shown when continuous loop is active) -->
        <div class="series-panel" id="seriesPanel" style="display: none;">
            <div class="series-header">
                <div class="series-title">
                    <span class="series-active-dot"></span>
                    Continuous Loop Active
                </div>
                <span id="seriesRuntime" style="color: var(--text-secondary); font-size: 13px;">0m 0s</span>
            </div>
            <div class="series-stats">
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesCurrentSession">1</div>
                    <div class="series-stat-label">Current Session</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesCompleted">0</div>
                    <div class="series-stat-label">Completed</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesTotalTokens">0</div>
                    <div class="series-stat-label">Total Tokens</div>
                </div>
                <div class="series-stat">
                    <div class="series-stat-value" id="seriesTotalCost">$0.00</div>
                    <div class="series-stat-label">Total Cost</div>
                </div>
            </div>
            <div class="series-history" id="seriesHistory">
                <!-- Session chips will be rendered here -->
            </div>
        </div>

        <!-- Execution State Panel -->
        <div class="execution-panel" id="executionPanel" style="display: none;">
            <!-- Current Phase -->
            <div class="phase-card">
                <div class="phase-card-header">
                    <span class="phase-card-title">Current Phase</span>
                    <span class="phase-badge" id="phaseBadge">research</span>
                </div>
                <div class="phase-name" id="phaseName">Research</div>
                <div class="phase-iteration" id="phaseIteration">Iteration 1 of 10</div>
                <div class="phase-history" id="phaseHistory">
                    <!-- Phase history dots -->
                </div>
            </div>

            <!-- Quality Scores -->
            <div class="scores-card">
                <div class="score-header">
                    <div>
                        <div class="phase-card-title">Quality Score</div>
                        <div class="score-total" id="scoreTotal">--</div>
                    </div>
                    <div class="score-threshold" id="scoreThreshold">Min: 80</div>
                </div>
                <div class="score-criteria" id="scoreCriteria">
                    <!-- Criteria bars will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Todo Progress Panel -->
        <div class="todos-panel" id="todosPanel" style="display: none;">
            <div class="todos-header">
                <span class="todos-title">Task Progress</span>
                <div class="todos-progress">
                    <div class="todos-progress-bar">
                        <div class="todos-progress-fill" id="todosProgressFill" style="width: 0%"></div>
                    </div>
                    <span class="todos-progress-text" id="todosProgressText">0/0</span>
                </div>
            </div>
            <div class="todos-list" id="todosList">
                <!-- Todo items will be rendered here -->
            </div>
        </div>

        <!-- Backlog Tasks Panel (from tasks.json) -->
        <div class="backlog-panel" id="backlogPanel" style="display: none;">
            <div class="backlog-header">
                <span class="backlog-title">ðŸ“‹ Backlog Tasks</span>
                <div class="backlog-stats">
                    <span class="backlog-stat" id="backlogInProgress">0 in progress</span>
                    <span class="backlog-stat" id="backlogReady">0 ready</span>
                </div>
            </div>
            <div class="backlog-list" id="backlogList">
                <!-- Tasks will be rendered here -->
            </div>
        </div>

        <!-- Confidence Monitor Panel -->
        <div class="confidence-panel" id="confidencePanel" style="display: none;">
            <div class="confidence-header">
                <span class="confidence-title">ðŸŽ¯ Agent Confidence</span>
                <span class="confidence-status" id="confidenceStatus">Healthy</span>
            </div>
            <div class="confidence-content">
                <!-- Circular Gauge -->
                <div class="confidence-gauge">
                    <svg width="140" height="140" viewBox="0 0 140 140">
                        <circle class="confidence-gauge-bg" cx="70" cy="70" r="58"></circle>
                        <circle class="confidence-gauge-fill healthy" id="confidenceGaugeFill" cx="70" cy="70" r="58"
                            stroke-dasharray="364.4" stroke-dashoffset="364.4"></circle>
                    </svg>
                    <div class="confidence-gauge-value">
                        <div class="confidence-gauge-number" id="confidenceValue">--</div>
                        <div class="confidence-gauge-label">confidence</div>
                    </div>
                </div>

                <!-- Signal Breakdown -->
                <div class="confidence-signals" id="confidenceSignals">
                    <div class="confidence-signal">
                        <span class="signal-icon">ðŸ“Š</span>
                        <div class="signal-info">
                            <div class="signal-name">Quality Score</div>
                            <div class="signal-bar"><div class="signal-fill" id="signalQuality" style="width: 0%; background: var(--success);"></div></div>
                        </div>
                        <span class="signal-value" id="signalQualityValue">--</span>
                    </div>
                    <div class="confidence-signal">
                        <span class="signal-icon">âš¡</span>
                        <div class="signal-info">
                            <div class="signal-name">Velocity</div>
                            <div class="signal-bar"><div class="signal-fill" id="signalVelocity" style="width: 0%; background: var(--info);"></div></div>
                        </div>
                        <span class="signal-value" id="signalVelocityValue">--</span>
                    </div>
                    <div class="confidence-signal">
                        <span class="signal-icon">ðŸ”„</span>
                        <div class="signal-info">
                            <div class="signal-name">Iterations</div>
                            <div class="signal-bar"><div class="signal-fill" id="signalIterations" style="width: 0%; background: var(--warning);"></div></div>
                        </div>
                        <span class="signal-value" id="signalIterationsValue">--</span>
                    </div>
                    <div class="confidence-signal">
                        <span class="signal-icon">âŒ</span>
                        <div class="signal-info">
                            <div class="signal-name">Error Rate</div>
                            <div class="signal-bar"><div class="signal-fill" id="signalErrorRate" style="width: 0%; background: var(--danger);"></div></div>
                        </div>
                        <span class="signal-value" id="signalErrorRateValue">--</span>
                    </div>
                    <div class="confidence-signal">
                        <span class="signal-icon">ðŸ“ˆ</span>
                        <div class="signal-info">
                            <div class="signal-name">Historical</div>
                            <div class="signal-bar"><div class="signal-fill" id="signalHistorical" style="width: 0%; background: #a371f7;"></div></div>
                        </div>
                        <span class="signal-value" id="signalHistoricalValue">--</span>
                    </div>
                </div>

                <!-- Trend Line -->
                <div class="confidence-trend">
                    <div class="trend-title">Confidence Trend (Last 10)</div>
                    <svg class="trend-chart" viewBox="0 0 180 70" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color: var(--info); stop-opacity: 0.4"/>
                                <stop offset="100%" style="stop-color: var(--info); stop-opacity: 0"/>
                            </linearGradient>
                        </defs>
                        <path class="trend-area" id="trendArea" d=""></path>
                        <polyline class="trend-line" id="trendLine" points=""></polyline>
                        <g id="trendPoints"></g>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Competitive Planning Panel -->
        <div class="planning-panel" id="planningPanel" style="display: none;">
            <div class="planning-header">
                <span class="planning-title">
                    <span class="planning-title-icon">ðŸ†</span>
                    Plan Strategies
                </span>
                <span class="complexity-badge" id="taskComplexityBadge">
                    <span class="complexity-stars" id="complexityStars"></span>
                    <span id="complexityStrategy">--</span>
                    <div class="complexity-tooltip" id="complexityTooltip">
                        <div class="tooltip-title">Complexity Breakdown</div>
                        <div class="tooltip-dimensions" id="complexityDimensions">
                            <!-- Dimensions will be rendered here -->
                        </div>
                    </div>
                </span>
            </div>
            <div class="planning-cards" id="planningCards">
                <!-- Plan cards will be rendered here -->
            </div>
        </div>

        <div id="activeSessionsContainer">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“­</div>
                <div class="empty-state-text">No active sessions</div>
                <div class="empty-state-sub">Start a Claude Code session to begin monitoring</div>
            </div>
        </div>

        <!-- Recent Completions Table -->
        <div class="recent-completions-panel" id="recentCompletionsPanel">
            <div class="recent-completions-header">
                <span class="recent-completions-title">Recent Completions</span>
                <span class="recent-completions-link" onclick="viewAllHistory()">View All History</span>
            </div>
            <div id="recentCompletionsBody">
                <table class="recent-completions-table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Task</th>
                            <th>Score</th>
                            <th>Cost</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody id="recentCompletionsList">
                        <tr>
                            <td colspan="5" class="empty-completions">No recent completions</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inactive Projects (Collapsed) -->
        <div class="inactive-section" id="inactiveSection" style="display: none;">
            <div class="inactive-header" onclick="toggleInactive()">
                <span id="inactiveCount">0 inactive projects</span>
                <span id="inactiveToggle">â–¼</span>
            </div>
            <div class="inactive-list" id="inactiveList"></div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="shortcuts-modal" style="display: none;">
        <div class="shortcuts-content">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="shortcuts-close" onclick="hideShortcutsModal()">&times;</button>
            </div>
            <div class="shortcuts-body">
                <div class="shortcuts-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-row">
                        <kbd>j</kbd> / <kbd>â†“</kbd>
                        <span>Next session card</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>k</kbd> / <kbd>â†‘</kbd>
                        <span>Previous session card</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Enter</kbd>
                        <span>Open selected session</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Esc</kbd>
                        <span>Close modal / detail view</span>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h3>Log Viewer</h3>
                    <div class="shortcut-row">
                        <kbd>/</kbd>
                        <span>Focus search</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>p</kbd>
                        <span>Pause/Resume log stream</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>c</kbd>
                        <span>Clear log display</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>a</kbd>
                        <span>Toggle auto-scroll</span>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h3>General</h3>
                    <div class="shortcut-row">
                        <kbd>?</kbd>
                        <span>Show this help</span>
                    </div>
                </div>
            </div>
            <div class="shortcuts-footer">
                Press <kbd>Esc</kbd> to close
            </div>
        </div>
    </div>

    <!-- Session Detail View (hidden by default) -->
    <div id="detailView" class="detail-view" style="display: none;">
        <header class="detail-header">
            <button class="back-btn" onclick="hideDetailView()">â† Back to Command Center</button>
            <div class="detail-controls">
                <button class="control-btn pause" id="detailPauseBtn" onclick="togglePauseSession()">Pause</button>
                <button class="control-btn danger" onclick="endSession()">End Session</button>
            </div>
        </header>

        <div class="detail-project-info">
            <h1 id="detailProjectName">Project Name</h1>
            <span class="detail-status" id="detailStatus">â— RUNNING</span>
            <div class="detail-path" id="detailPath">C:\path\to\project</div>
        </div>

        <!-- 3-Column Metrics Header -->
        <div class="detail-metrics-row">
            <div class="detail-metric-card">
                <div class="metric-title">CONTEXT</div>
                <div class="metric-progress">
                    <div class="metric-progress-bar">
                        <div class="metric-progress-fill" id="detailContextFill" style="width: 0%"></div>
                    </div>
                    <span class="metric-percent" id="detailContextPercent">0%</span>
                </div>
                <div class="metric-details">
                    <span id="detailTokensUsed">0 / 200K tokens</span>
                    <span id="detailTokensRemaining">~200K until compact</span>
                </div>
            </div>

            <div class="detail-metric-card">
                <div class="metric-title">SESSION</div>
                <div class="metric-main" id="detailRuntime">0m 0s</div>
                <div class="metric-details">
                    <span id="detailIteration">Iteration: 1 of 10</span>
                    <span id="detailPhase">Phase: implement</span>
                </div>
            </div>

            <div class="detail-metric-card">
                <div class="metric-title">COST</div>
                <div class="metric-main">
                    <span id="detailCost">$0.00</span>
                    <span class="metric-budget">/ $10.00</span>
                </div>
                <div class="metric-progress">
                    <div class="metric-progress-bar">
                        <div class="metric-progress-fill cost" id="detailCostFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-details">
                    <span id="detailTokenBreakdown">In: 0 / Out: 0</span>
                </div>
            </div>
        </div>

        <!-- Current Task + Quality/Confidence Split -->
        <div class="detail-split-panel">
            <div class="detail-task-panel">
                <div class="panel-header">
                    <span class="panel-title">CURRENT TASK</span>
                    <span class="phase-badge" id="detailTaskPhase">implement</span>
                </div>
                <h2 id="detailTaskTitle">Loading...</h2>
                <div class="task-meta">
                    <span id="detailTaskPriority">Priority: high</span>
                    <span id="detailTaskEstimate">Estimate: 2h</span>
                </div>

                <div class="acceptance-section">
                    <div class="acceptance-header">
                        <span>ACCEPTANCE CRITERIA</span>
                        <span class="acceptance-progress" id="acceptanceProgress">0/0</span>
                    </div>
                    <div class="acceptance-list" id="acceptanceCriteriaList">
                        <!-- Criteria items will be rendered here -->
                    </div>
                    <div class="acceptance-bar">
                        <div class="acceptance-bar-fill" id="acceptanceBarFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="detail-quality-panel">
                <div class="panel-header">
                    <span class="panel-title">QUALITY & CONFIDENCE</span>
                </div>

                <div class="quality-score-box">
                    <span class="quality-score-value" id="detailQualityScore">--</span>
                    <span class="quality-score-label">Quality Score</span>
                </div>

                <div class="confidence-mini-gauge">
                    <div class="confidence-mini-circle">
                        <svg width="80" height="80" viewBox="0 0 80 80">
                            <circle class="confidence-mini-bg" cx="40" cy="40" r="32"></circle>
                            <circle class="confidence-mini-fill" id="detailConfidenceFill" cx="40" cy="40" r="32"
                                stroke-dasharray="201" stroke-dashoffset="201"></circle>
                        </svg>
                        <div class="confidence-mini-value" id="detailConfidenceValue">--</div>
                    </div>
                    <span class="confidence-mini-label">Confidence</span>
                </div>

                <div class="signals-list" id="detailSignalsList">
                    <div class="signal-row">
                        <span class="signal-name">Quality</span>
                        <div class="signal-bar"><div class="signal-fill" id="detailSignalQuality" style="width: 0%"></div></div>
                        <span class="signal-value" id="detailSignalQualityVal">--</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Velocity</span>
                        <div class="signal-bar"><div class="signal-fill velocity" id="detailSignalVelocity" style="width: 0%"></div></div>
                        <span class="signal-value" id="detailSignalVelocityVal">--</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Iterations</span>
                        <div class="signal-bar"><div class="signal-fill iterations" id="detailSignalIterations" style="width: 0%"></div></div>
                        <span class="signal-value" id="detailSignalIterationsVal">--</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Error Rate</span>
                        <div class="signal-bar"><div class="signal-fill error" id="detailSignalErrorRate" style="width: 0%"></div></div>
                        <span class="signal-value" id="detailSignalErrorRateVal">--</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Historical</span>
                        <div class="signal-bar"><div class="signal-fill historical" id="detailSignalHistorical" style="width: 0%"></div></div>
                        <span class="signal-value" id="detailSignalHistoricalVal">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Queue -->
        <div class="detail-queue-panel">
            <div class="panel-header">
                <span class="panel-title">TASK QUEUE</span>
                <span class="queue-count" id="queueCount">0 tasks</span>
            </div>
            <table class="queue-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Task</th>
                        <th>Priority</th>
                        <th>Phase</th>
                        <th>Estimate</th>
                    </tr>
                </thead>
                <tbody id="taskQueueBody">
                    <!-- Task rows will be rendered here -->
                </tbody>
            </table>
        </div>

        <!-- Live Log Viewer -->
        <div class="detail-log-panel collapsed" id="logPanel">
            <div class="log-header" onclick="toggleLogPanel()">
                <div class="log-header-left">
                    <span class="log-streaming-dot" id="logStreamingDot"></span>
                    <span class="panel-title">LIVE LOG</span>
                    <span class="log-status-text" id="logStatusText">Click to expand</span>
                </div>
                <span class="log-expand-icon">â–¼</span>
            </div>
            <div class="log-content" id="logContent" style="display: none;">
                <div class="log-controls">
                    <div class="log-controls-left">
                        <label class="log-checkbox-label">
                            <input type="checkbox" id="logAutoScroll" checked />
                            Auto-scroll
                        </label>
                        <select id="logLevelFilter" class="log-select">
                            <option value="all">All Levels</option>
                            <option value="ERROR">Errors Only</option>
                            <option value="WARN">Warnings+</option>
                            <option value="INFO">Info+</option>
                            <option value="DEBUG">Debug+</option>
                        </select>
                    </div>
                    <div class="log-search-container">
                        <input type="text" id="logSearchInput" class="log-search-input" placeholder="Search logs... (press /)" />
                        <span class="log-search-count" id="logSearchCount"></span>
                        <button class="log-search-btn" id="logSearchPrev" onclick="navigateSearch(-1)" title="Previous match (Shift+Enter)">â†‘</button>
                        <button class="log-search-btn" id="logSearchNext" onclick="navigateSearch(1)" title="Next match (Enter)">â†“</button>
                        <button class="log-search-btn" id="logSearchClear" onclick="clearSearch()" title="Clear search (Esc)">Ã—</button>
                    </div>
                    <div class="log-controls-right">
                        <button class="log-control-btn" id="logPauseBtn" onclick="toggleLogPause()">
                            <span id="logPauseIcon">â¸</span> <span id="logPauseText">Pause</span>
                        </button>
                        <button class="log-control-btn" onclick="clearLogDisplay()">Clear</button>
                    </div>
                </div>
                <div class="log-output-container">
                    <div class="log-output" id="logOutput">
                        <div class="log-empty-message">Connecting to log stream...</div>
                    </div>
                </div>
                <div class="log-history-nav">
                    <div class="log-history-left">
                        <button class="log-nav-btn" id="logOlderBtn" onclick="loadOlderLogs()" title="Load older logs">
                            â† Older
                        </button>
                        <span class="log-time-range" id="logTimeRange">-</span>
                        <button class="log-nav-btn" id="logNewerBtn" onclick="loadNewerLogs()" title="Load newer logs">
                            Newer â†’
                        </button>
                    </div>
                    <div class="log-history-right">
                        <input type="datetime-local" id="logJumpTime" class="log-time-input" title="Jump to specific time" />
                        <button class="log-nav-btn" onclick="jumpToTime()" title="Jump to time">Go</button>
                        <button class="log-nav-btn" onclick="jumpToLatest()" title="Jump to latest (live)">Latest</button>
                    </div>
                </div>
                <div class="log-footer">
                    <span class="log-line-count" id="logLineCount">Lines: 0</span>
                    <span class="log-level-counts" id="logLevelCounts">
                        <span class="log-count-error" id="logErrorCount">E: 0</span>
                        <span class="log-count-warn" id="logWarnCount">W: 0</span>
                    </span>
                    <span class="log-session-info" id="logSessionInfo">Session: -</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ========== SESSION DETAIL VIEW STYLES ========== */
        .detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            overflow-y: auto;
            z-index: 100;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--info);
            color: var(--info);
        }

        .detail-controls {
            display: flex;
            gap: 12px;
        }

        .control-btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn.pause {
            background: var(--warning);
            border: none;
            color: #000;
        }

        .control-btn.pause:hover {
            background: #e8a832;
        }

        .control-btn.pause.paused {
            background: var(--success);
        }

        .control-btn.danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .control-btn.danger:hover {
            background: var(--danger);
            color: #fff;
        }

        .detail-project-info {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .detail-project-info h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .detail-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 12px;
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        .detail-status.paused {
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
        }

        .detail-path {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-top: 4px;
        }

        /* 3-Column Metrics Row */
        .detail-metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        @media (max-width: 900px) {
            .detail-metrics-row {
                grid-template-columns: 1fr;
            }
        }

        .detail-metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .metric-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .metric-main {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-budget {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .metric-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .metric-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .metric-progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .metric-progress-fill.warning { background: var(--warning); }
        .metric-progress-fill.critical { background: var(--danger); }
        .metric-progress-fill.cost { background: var(--info); }

        .metric-percent {
            font-size: 20px;
            font-weight: 700;
            min-width: 50px;
        }

        .metric-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Split Panel */
        .detail-split-panel {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px 24px;
        }

        @media (max-width: 900px) {
            .detail-split-panel {
                grid-template-columns: 1fr;
            }
        }

        .detail-task-panel, .detail-quality-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .detail-task-panel h2 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .task-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Acceptance Criteria */
        .acceptance-section {
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .acceptance-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .acceptance-progress {
            color: var(--text-primary);
            font-weight: 600;
        }

        .acceptance-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .acceptance-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
        }

        .acceptance-item.met {
            opacity: 0.7;
        }

        .acceptance-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .acceptance-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .acceptance-checkbox.checked::after {
            content: 'âœ“';
            color: #fff;
            font-size: 11px;
            font-weight: bold;
        }

        .acceptance-item.met .acceptance-text {
            text-decoration: line-through;
        }

        .acceptance-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .acceptance-bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Quality Panel */
        .quality-score-box {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .quality-score-value {
            font-size: 42px;
            font-weight: 700;
            display: block;
            color: var(--success);
        }

        .quality-score-value.close { color: var(--warning); }
        .quality-score-value.failing { color: var(--danger); }

        .quality-score-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .confidence-mini-gauge {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .confidence-mini-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .confidence-mini-circle svg {
            transform: rotate(-90deg);
        }

        .confidence-mini-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .confidence-mini-fill {
            fill: none;
            stroke: var(--success);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s;
        }

        .confidence-mini-fill.warning { stroke: var(--warning); }
        .confidence-mini-fill.critical { stroke: var(--danger); }

        .confidence-mini-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 700;
        }

        .confidence-mini-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .signals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .signal-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signal-row .signal-name {
            width: 70px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .signal-row .signal-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .signal-row .signal-fill {
            height: 100%;
            background: var(--success);
            border-radius: 2px;
        }

        .signal-row .signal-fill.velocity { background: var(--info); }
        .signal-row .signal-fill.iterations { background: var(--warning); }
        .signal-row .signal-fill.error { background: var(--danger); }
        .signal-row .signal-fill.historical { background: #a371f7; }

        .signal-row .signal-value {
            width: 28px;
            font-size: 11px;
            font-weight: 600;
            text-align: right;
        }

        /* Task Queue Panel */
        .detail-queue-panel {
            margin: 0 24px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .queue-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .queue-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .queue-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
        }

        .queue-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .queue-table tr:last-child td {
            border-bottom: none;
        }

        .queue-table tr:hover {
            background: var(--bg-tertiary);
        }

        .queue-table .next-badge {
            background: var(--info);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        .queue-table .priority-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.critical { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
        .priority-badge.high { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .priority-badge.medium { background: rgba(88, 166, 255, 0.2); color: var(--info); }
        .priority-badge.low { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }

        /* Live Log Viewer */
        .detail-log-panel {
            margin: 0 24px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .log-header:hover {
            background: var(--bg-tertiary);
        }

        .log-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .log-streaming-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .log-streaming-dot.streaming {
            background: var(--success);
            animation: pulse-stream 1.5s infinite;
        }

        .log-streaming-dot.paused {
            background: var(--warning);
        }

        .log-streaming-dot.disconnected {
            background: var(--danger);
        }

        @keyframes pulse-stream {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(63, 185, 80, 0); }
        }

        .log-status-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .log-expand-icon {
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .detail-log-panel.expanded .log-expand-icon {
            transform: rotate(180deg);
        }

        .log-content {
            border-top: 1px solid var(--border);
            background: #0a0c10;
        }

        .log-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .log-controls-left, .log-controls-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .log-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .log-checkbox-label input {
            width: 14px;
            height: 14px;
        }

        .log-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .log-control-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-control-btn:hover {
            background: var(--border);
        }

        /* Log Search - Phase 4 Polish */
        .log-search-container {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            max-width: 300px;
            margin: 0 12px;
        }

        .log-search-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            padding: 6px 10px;
            font-size: 12px;
            min-width: 120px;
        }

        .log-search-input:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        .log-search-input::placeholder {
            color: var(--text-secondary);
        }

        .log-search-count {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .log-search-count.has-matches {
            color: var(--success);
        }

        .log-search-count.no-matches {
            color: var(--danger);
        }

        .log-search-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .log-search-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .log-search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Search highlight styles */
        .log-entry .search-highlight {
            background: rgba(255, 213, 0, 0.4);
            color: inherit;
            border-radius: 2px;
            padding: 0 1px;
        }

        .log-entry.search-match {
            background: rgba(88, 166, 255, 0.1);
        }

        .log-entry.search-current {
            background: rgba(255, 213, 0, 0.2);
            border-left: 3px solid var(--warning);
        }

        /* Historical Navigation - Phase 4 Polish */
        .log-history-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            font-size: 12px;
        }

        .log-history-left, .log-history-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-nav-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-nav-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .log-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-nav-btn.active {
            background: var(--info);
            color: #000;
            border-color: var(--info);
        }

        .log-time-range {
            color: var(--text-secondary);
            font-size: 11px;
            white-space: nowrap;
        }

        .log-time-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            padding: 4px 8px;
            font-size: 11px;
        }

        .log-time-input:focus {
            outline: none;
            border-color: var(--info);
        }

        .log-control-btn.paused {
            background: var(--warning);
            color: #000;
            border-color: var(--warning);
        }

        .log-output-container {
            height: 300px;
            overflow: hidden;
        }

        .log-output {
            height: 100%;
            overflow-y: auto;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-empty-message {
            color: var(--text-secondary);
            text-align: center;
            padding: 40px 20px;
        }

        .log-entry {
            display: flex;
            gap: 8px;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .log-timestamp {
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .log-level {
            font-weight: 600;
            flex-shrink: 0;
            min-width: 50px;
        }

        .log-level.INFO { color: var(--info); }
        .log-level.WARN { color: var(--warning); }
        .log-level.ERROR { color: var(--danger); }
        .log-level.DEBUG { color: var(--text-secondary); }

        .log-message {
            color: var(--text-primary);
            flex: 1;
        }

        .log-entry.ERROR .log-message { color: var(--danger); }
        .log-entry.WARN .log-message { color: var(--warning); }

        .log-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .log-level-counts {
            display: flex;
            gap: 12px;
        }

        .log-count-error { color: var(--danger); }
        .log-count-warn { color: var(--warning); }

        /* ======================================
           DETAIL VIEW RESPONSIVE - Phase 4 Polish
           ====================================== */

        /* Tablets (900px) */
        @media (max-width: 900px) {
            .detail-header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }

            .back-btn {
                align-self: flex-start;
            }

            .detail-controls {
                width: 100%;
                justify-content: flex-end;
            }

            .detail-project-info {
                padding: 16px;
            }

            .detail-project-info h1 {
                font-size: 20px;
            }
        }

        /* Small tablets (768px) */
        @media (max-width: 768px) {
            .detail-controls {
                flex-direction: column;
                gap: 8px;
            }

            .control-btn {
                width: 100%;
                min-height: 44px;
            }

            .log-controls {
                flex-direction: column;
                gap: 8px;
            }

            .log-controls-left, .log-controls-right {
                width: 100%;
                justify-content: space-between;
            }

            .log-search-container {
                order: -1;
                width: 100%;
                max-width: none;
                margin: 0 0 8px 0;
            }

            .log-history-nav {
                flex-direction: column;
                gap: 8px;
            }

            .log-history-left, .log-history-right {
                width: 100%;
                justify-content: center;
            }
        }

        /* Mobile (480px) */
        @media (max-width: 480px) {
            .detail-header {
                padding: 12px;
            }

            .back-btn {
                font-size: 13px;
                padding: 8px 12px;
                min-height: 44px;
            }

            .detail-project-info {
                padding: 12px;
            }

            .detail-project-info h1 {
                font-size: 18px;
            }

            .detail-status {
                font-size: 11px;
            }

            .detail-path {
                font-size: 11px;
            }

            .detail-metrics-row {
                padding: 12px;
                gap: 12px;
            }

            .metric-card {
                padding: 12px;
            }

            .metric-value {
                font-size: 24px;
            }

            .metric-label {
                font-size: 10px;
            }

            .detail-split-panel {
                padding: 12px;
                gap: 12px;
            }

            .detail-task-panel, .detail-quality-panel {
                padding: 12px;
            }

            .acceptance-item {
                padding: 6px 10px;
                font-size: 12px;
            }

            .task-queue-table th,
            .task-queue-table td {
                padding: 8px 6px;
                font-size: 11px;
            }

            /* Log viewer on mobile */
            .log-output-container {
                height: 200px;
            }

            .log-entry {
                padding: 4px 8px;
                font-size: 11px;
            }

            .log-timestamp {
                display: none;
            }

            .log-footer {
                flex-direction: column;
                gap: 4px;
                text-align: center;
            }

            /* Confidence gauge smaller on mobile */
            .detail-confidence-gauge svg {
                width: 80px;
                height: 80px;
            }

            .confidence-signal-bar {
                height: 6px;
            }
        }
    </style>

    <script>
        const API_URL = 'http://localhost:3033';
        let soundEnabled = true;
        let audioContext = null;
        let lastAlertLevel = null;
        let eventSource = null;
        let currentDetailSessionId = null;
        let detailRefreshInterval = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlertSound(frequency = 800, duration = 0.3, count = 1) {
            if (!soundEnabled) return;
            initAudio();

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                }, i * (duration * 1000 + 100));
            }
        }

        function formatTokens(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toLocaleString();
        }

        function getStatusClass(usedPercent) {
            // Based on context remaining (100 - used)
            // Thresholds: <25% remaining = emergency, <35% = critical, <50% = warning
            const remaining = 100 - usedPercent;
            if (remaining <= 25) return 'emergency';   // â‰¤25% remaining (~5k until compact)
            if (remaining <= 35) return 'critical';    // â‰¤35% remaining (~25k until compact)
            if (remaining <= 50) return 'warning';     // â‰¤50% remaining (~55k until compact)
            return 'ok';
        }

        function copyCommand(cmd) {
            navigator.clipboard.writeText(cmd);
            // Brief visual feedback
            event.target.textContent = 'Copied!';
            setTimeout(() => { event.target.textContent = `Copy ${cmd}`; }, 1000);
        }

        function toggleInactive() {
            const list = document.getElementById('inactiveList');
            const toggle = document.getElementById('inactiveToggle');
            list.classList.toggle('show');
            toggle.textContent = list.classList.contains('show') ? 'â–²' : 'â–¼';
        }

        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // ======================================
        // COMMAND CENTER - Global Metrics & Usage Limits
        // ======================================

        let usageLimitsInterval = null;
        let globalMetricsData = null;
        let usageLimitsData = null;

        function getUsageLimitClass(percent) {
            if (percent >= 90) return 'critical';
            if (percent >= 75) return 'warning';
            if (percent >= 50) return 'caution';
            return 'safe';
        }

        function getUsageLimitColor(percent) {
            if (percent >= 90) return 'var(--danger)';
            if (percent >= 75) return '#f0883e';
            if (percent >= 50) return 'var(--warning)';
            return 'var(--success)';
        }

        async function fetchGlobalMetrics() {
            try {
                const response = await fetch(`${API_URL}/api/sessions/summary`);
                if (response.ok) {
                    const data = await response.json();
                    globalMetricsData = data;
                    updateGlobalMetricsUI(data);
                    updateRecentCompletions(data.recentCompletions || []);
                }
            } catch (err) {
                console.error('Failed to fetch global metrics:', err);
            }
        }

        async function fetchUsageLimits() {
            try {
                const response = await fetch(`${API_URL}/api/usage/limits`);
                if (response.ok) {
                    const data = await response.json();
                    usageLimitsData = data;
                    updateUsageLimitsUI(data);
                }
            } catch (err) {
                console.error('Failed to fetch usage limits:', err);
            }
        }

        function updateGlobalMetricsUI(data) {
            const metrics = data.globalMetrics || {};
            const sessions = data.sessions || [];

            // Active Sessions count
            const activeCount = sessions.filter(s => s.status === 'active').length;
            document.getElementById('metricActiveSessions').textContent = activeCount;

            // Tasks Done Today
            const tasksCompleted = metrics.tasksCompletedToday || 0;
            const totalTasks = metrics.totalTasksToday || tasksCompleted;
            document.getElementById('metricTasksDone').textContent = `${tasksCompleted} / ${totalTasks}`;

            // Avg Health Score
            const healthScore = metrics.avgHealthScore || 0;
            document.getElementById('metricHealthScore').textContent = `${Math.round(healthScore)}%`;

            // Cost Today with trend
            const costToday = metrics.totalCostToday || 0;
            const costTrend = metrics.costTrend || 0;
            const costEl = document.getElementById('metricCostToday');
            let trendHtml = '';
            if (costTrend > 0) {
                trendHtml = `<span class="metric-trend up">â†‘ $${costTrend.toFixed(2)}</span>`;
            } else if (costTrend < 0) {
                trendHtml = `<span class="metric-trend down">â†“ $${Math.abs(costTrend).toFixed(2)}</span>`;
            }
            costEl.innerHTML = `<span>$${costToday.toFixed(2)}</span>${trendHtml}`;

            // Active Alerts
            const alertCount = metrics.alertCount || 0;
            const alertsEl = document.getElementById('metricAlerts');
            const alertsCard = document.getElementById('metricAlertsCard');
            if (alertCount > 0) {
                alertsEl.innerHTML = `<span class="alert-badge">${alertCount}</span>`;
                alertsCard.classList.add('alert');
            } else {
                alertsEl.textContent = '0';
                alertsCard.classList.remove('alert');
            }
        }

        function updateUsageLimitsUI(data) {
            // Check if any limit needs alert banner
            const alertBanner = document.getElementById('usageAlertBanner');
            let showAlert = false;
            let alertMessage = '';

            // 5-Hour Window
            if (data.fiveHour) {
                const fh = data.fiveHour;
                const percent = fh.percent || 0;
                const limitClass = getUsageLimitClass(percent);

                document.getElementById('usage5hPercent').textContent = `${Math.round(percent)}%`;
                document.getElementById('usage5hPercent').className = `usage-limit-percent ${limitClass}`;
                document.getElementById('usage5hPercent').style.color = getUsageLimitColor(percent);

                document.getElementById('usage5hFill').style.width = `${Math.min(percent, 100)}%`;
                document.getElementById('usage5hFill').className = `usage-limit-fill ${limitClass}`;

                document.getElementById('usage5hUsed').textContent = `${fh.used || 0} / ${fh.limit || 0} messages`;
                document.getElementById('usage5hReset').textContent = fh.resetIn || '--';

                // Pace indicator
                const paceEl = document.getElementById('usage5hPace');
                if (fh.pace) {
                    const paceClass = fh.pace.status || 'safe';
                    paceEl.innerHTML = `
                        <span class="pace-indicator ${paceClass}"></span>
                        <span>Pace: ${fh.pace.current || '--'} msg/hr (safe: ${fh.pace.safe || '--'}/hr)</span>
                    `;
                }

                if (percent >= 90) {
                    showAlert = true;
                    alertMessage = `5-hour usage at ${Math.round(percent)}% - Resets in ${fh.resetIn || 'soon'}`;
                }
            }

            // Daily Limit
            if (data.daily) {
                const d = data.daily;
                const percent = d.percent || 0;
                const limitClass = getUsageLimitClass(percent);

                document.getElementById('usageDailyPercent').textContent = `${Math.round(percent)}%`;
                document.getElementById('usageDailyPercent').className = `usage-limit-percent ${limitClass}`;
                document.getElementById('usageDailyPercent').style.color = getUsageLimitColor(percent);

                document.getElementById('usageDailyFill').style.width = `${Math.min(percent, 100)}%`;
                document.getElementById('usageDailyFill').className = `usage-limit-fill ${limitClass}`;

                document.getElementById('usageDailyUsed').textContent = `${d.used || 0} / ${d.limit || 0} messages`;
                document.getElementById('usageDailyReset').textContent = d.resetIn || '--';

                // Projected usage
                if (d.projected) {
                    document.getElementById('usageDailyProjected').textContent =
                        `${d.projected.endOfDay || '--'} (${d.projected.percentOfLimit || '--'}% of limit)`;
                }

                if (percent >= 90 && !showAlert) {
                    showAlert = true;
                    alertMessage = `Daily usage at ${Math.round(percent)}% - Resets in ${d.resetIn || 'soon'}`;
                }
            }

            // Weekly Limit
            if (data.weekly) {
                const w = data.weekly;
                const percent = w.percent || 0;
                const limitClass = getUsageLimitClass(percent);

                document.getElementById('usageWeeklyPercent').textContent = `${Math.round(percent)}%`;
                document.getElementById('usageWeeklyPercent').className = `usage-limit-percent ${limitClass}`;
                document.getElementById('usageWeeklyPercent').style.color = getUsageLimitColor(percent);

                document.getElementById('usageWeeklyFill').style.width = `${Math.min(percent, 100)}%`;
                document.getElementById('usageWeeklyFill').className = `usage-limit-fill ${limitClass}`;

                const usedDisplay = w.used >= 1000 ? `${(w.used / 1000).toFixed(1)}K` : w.used;
                const limitDisplay = w.limit >= 1000 ? `${(w.limit / 1000).toFixed(1)}K` : w.limit;
                document.getElementById('usageWeeklyUsed').textContent = `${usedDisplay} / ${limitDisplay}`;
                document.getElementById('usageWeeklyReset').textContent = w.resetDay || '--';

                if (percent >= 90 && !showAlert) {
                    showAlert = true;
                    alertMessage = `Weekly usage at ${Math.round(percent)}% - Resets on ${w.resetDay || 'Monday'}`;
                }
            }

            // Show/hide alert banner
            if (showAlert) {
                alertBanner.textContent = `âš ï¸ ${alertMessage}`;
                alertBanner.classList.add('visible');
            } else {
                alertBanner.classList.remove('visible');
            }
        }

        function updateRecentCompletions(completions) {
            const tbody = document.getElementById('recentCompletionsList');

            if (!completions || completions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-completions">No recent completions</td>
                    </tr>
                `;
                return;
            }

            // Show last 5-10 completions
            const displayCompletions = completions.slice(0, 10);

            tbody.innerHTML = displayCompletions.map(c => {
                const score = c.score || c.qualityScore || 0;
                const scoreClass = score >= 90 ? 'high' : score >= 75 ? 'medium' : 'low';
                const cost = c.cost || 0;
                const completedAt = c.completedAt ? timeAgo(new Date(c.completedAt).getTime()) : '--';

                return `
                    <tr>
                        <td>${c.project || '--'}</td>
                        <td>${c.task || c.title || '--'}</td>
                        <td><span class="completion-score ${scoreClass}">${score}</span></td>
                        <td>$${cost.toFixed(2)}</td>
                        <td>${completedAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function viewAllHistory() {
            // TODO: Implement full history view modal or page
            alert('Full task history view coming soon!');
        }

        function startUsageLimitsRefresh() {
            // Fetch immediately
            fetchUsageLimits();
            // Then refresh every 1 minute (not 3 seconds to reduce API calls)
            usageLimitsInterval = setInterval(fetchUsageLimits, 60000);
        }

        function startGlobalMetricsRefresh() {
            // Fetch immediately
            fetchGlobalMetrics();
            // Refresh every 3 seconds along with SSE updates
            // (This is also updated via SSE, but this ensures initial load)
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function updateSessionSeries(series) {
            const panel = document.getElementById('seriesPanel');

            if (!series || !series.active) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            // Update stats
            document.getElementById('seriesCurrentSession').textContent = series.currentSession || 1;
            document.getElementById('seriesCompleted').textContent = series.sessions?.length || 0;
            document.getElementById('seriesTotalTokens').textContent = formatTokens(series.totalTokens || 0);
            document.getElementById('seriesTotalCost').textContent = `$${(series.totalCost || 0).toFixed(2)}`;

            // Update runtime
            if (series.startTime) {
                const runtime = Date.now() - new Date(series.startTime).getTime();
                document.getElementById('seriesRuntime').textContent = formatDuration(runtime);
            }

            // Update session history chips
            const history = document.getElementById('seriesHistory');
            if (series.sessions && series.sessions.length > 0) {
                history.innerHTML = series.sessions.map((s, i) => {
                    const chipClass = s.exitReason === 'threshold' ? 'threshold' :
                                     s.exitReason === 'complete' ? 'complete' :
                                     s.exitReason === 'error' ? 'error' : '';
                    const icon = s.exitReason === 'threshold' ? 'ðŸ”„' :
                                s.exitReason === 'complete' ? 'âœ…' :
                                s.exitReason === 'error' ? 'âŒ' : 'ðŸ“';
                    return `
                        <div class="series-session-chip ${chipClass}">
                            ${icon} Session ${s.sessionNumber}: ${s.peakContext?.toFixed(0) || 0}%
                        </div>
                    `;
                }).join('');

                // Add current session indicator
                if (series.currentSession > series.sessions.length) {
                    history.innerHTML += `
                        <div class="series-session-chip active">
                            âš¡ Session ${series.currentSession}: Running...
                        </div>
                    `;
                }
            } else {
                history.innerHTML = `
                    <div class="series-session-chip active">
                        âš¡ Session 1: Running...
                    </div>
                `;
            }
        }

        // Phase thresholds
        const PHASE_THRESHOLDS = {
            research: 80,
            design: 85,
            implement: 90,
            test: 90,
            complete: 100
        };

        // Confidence history for trend line
        let confidenceHistory = [];
        const MAX_CONFIDENCE_HISTORY = 10;

        function updateConfidencePanel(confidenceState) {
            const panel = document.getElementById('confidencePanel');

            if (!confidenceState || confidenceState.confidence === undefined) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            const confidence = confidenceState.confidence || 0;
            const level = confidenceState.level || 'healthy';
            const signals = confidenceState.signals || {};

            // Update gauge
            const gaugeFill = document.getElementById('confidenceGaugeFill');
            const gaugeValue = document.getElementById('confidenceValue');
            const circumference = 2 * Math.PI * 58; // r=58
            const offset = circumference - (confidence / 100) * circumference;

            gaugeFill.style.strokeDashoffset = offset;
            gaugeFill.className = `confidence-gauge-fill ${level}`;
            gaugeValue.textContent = Math.round(confidence);
            gaugeValue.className = `confidence-gauge-number`;
            gaugeValue.style.color = level === 'healthy' ? 'var(--success)' :
                                     level === 'warning' ? 'var(--warning)' :
                                     level === 'critical' ? 'var(--danger)' : 'var(--critical)';

            // Update status badge
            const statusBadge = document.getElementById('confidenceStatus');
            statusBadge.textContent = level.charAt(0).toUpperCase() + level.slice(1);
            statusBadge.className = `confidence-status ${level}`;

            // Update signals
            const signalMap = {
                qualityScore: { fill: 'signalQuality', value: 'signalQualityValue' },
                velocity: { fill: 'signalVelocity', value: 'signalVelocityValue' },
                iterations: { fill: 'signalIterations', value: 'signalIterationsValue' },
                errorRate: { fill: 'signalErrorRate', value: 'signalErrorRateValue' },
                historical: { fill: 'signalHistorical', value: 'signalHistoricalValue' }
            };

            Object.entries(signalMap).forEach(([key, ids]) => {
                const signalValue = signals[key] !== undefined ? signals[key] : 0;
                const fillEl = document.getElementById(ids.fill);
                const valueEl = document.getElementById(ids.value);
                if (fillEl) fillEl.style.width = `${signalValue}%`;
                if (valueEl) valueEl.textContent = Math.round(signalValue);
            });

            // Update trend line
            confidenceHistory.push(confidence);
            if (confidenceHistory.length > MAX_CONFIDENCE_HISTORY) {
                confidenceHistory.shift();
            }

            if (confidenceHistory.length >= 2) {
                const width = 180;
                const height = 70;
                const padding = 5;
                const points = confidenceHistory.map((val, i) => {
                    const x = padding + (i / (MAX_CONFIDENCE_HISTORY - 1)) * (width - padding * 2);
                    const y = height - padding - (val / 100) * (height - padding * 2);
                    return `${x},${y}`;
                });

                document.getElementById('trendLine').setAttribute('points', points.join(' '));

                // Area path
                const areaPath = `M ${padding},${height - padding} ` +
                    points.map((p, i) => (i === 0 ? `L ${p}` : `L ${p}`)).join(' ') +
                    ` L ${padding + ((confidenceHistory.length - 1) / (MAX_CONFIDENCE_HISTORY - 1)) * (width - padding * 2)},${height - padding} Z`;
                document.getElementById('trendArea').setAttribute('d', areaPath);

                // Points
                const pointsContainer = document.getElementById('trendPoints');
                pointsContainer.innerHTML = points.map(p => {
                    const [x, y] = p.split(',');
                    return `<circle class="trend-point" cx="${x}" cy="${y}" r="3"/>`;
                }).join('');
            }
        }

        function updatePlanningPanel(planComparison, complexity) {
            const panel = document.getElementById('planningPanel');

            if (!planComparison || !planComparison.plans || planComparison.plans.length === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            const plans = planComparison.plans;
            const winner = planComparison.winner;

            // Update complexity badge
            if (complexity) {
                updateComplexityBadge(complexity);
            }

            // Render plan cards
            const cardsContainer = document.getElementById('planningCards');
            cardsContainer.innerHTML = plans.map(plan => {
                const isWinner = winner && plan.strategy === winner.strategy;
                const scores = plan.scores || {};
                const criteria = ['completeness', 'feasibility', 'risk', 'clarity', 'efficiency'];

                return `
                    <div class="plan-card ${isWinner ? 'winner' : ''}">
                        <div class="plan-card-header">
                            <span class="plan-strategy ${plan.strategy}">${plan.strategy}</span>
                            <span class="plan-score">${Math.round(plan.totalScore || 0)}</span>
                        </div>
                        <div class="plan-criteria">
                            ${criteria.map(c => {
                                const score = scores[c] || 0;
                                const fillClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
                                return `
                                    <div class="plan-criterion">
                                        <span class="plan-criterion-name">${c}</span>
                                        <div class="plan-criterion-bar">
                                            <div class="plan-criterion-fill ${fillClass}" style="width: ${score}%"></div>
                                        </div>
                                        <span class="plan-criterion-value">${Math.round(score)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateComplexityBadge(complexity) {
            const badge = document.getElementById('taskComplexityBadge');
            const starsContainer = document.getElementById('complexityStars');
            const strategyLabel = document.getElementById('complexityStrategy');
            const dimensionsContainer = document.getElementById('complexityDimensions');

            if (!complexity) {
                badge.style.display = 'none';
                return;
            }

            badge.style.display = 'inline-flex';

            const score = complexity.score || 0;
            const strategy = complexity.strategy || 'standard';
            const dimensions = complexity.dimensions || {};

            // Update badge class
            badge.className = `complexity-badge ${strategy.replace('-', '')}`;

            // Update stars (1-5 based on score)
            const starCount = Math.min(5, Math.max(1, Math.ceil(score / 20)));
            starsContainer.innerHTML = Array(5).fill(0).map((_, i) =>
                `<span class="complexity-star ${i < starCount ? 'filled' : 'empty'}">â˜…</span>`
            ).join('');

            // Update strategy label
            const strategyLabels = {
                'fast-path': 'Simple',
                'standard': 'Standard',
                'competitive': 'Complex'
            };
            strategyLabel.textContent = strategyLabels[strategy] || strategy;

            // Update tooltip dimensions
            const dimNames = {
                dependencyDepth: 'Dependencies',
                acceptanceCriteria: 'Acceptance',
                effortEstimate: 'Effort',
                technicalKeywords: 'Technical',
                historicalSuccess: 'Historical'
            };

            dimensionsContainer.innerHTML = Object.entries(dimensions).map(([key, value]) => `
                <div class="tooltip-dimension">
                    <span class="tooltip-dim-name">${dimNames[key] || key}</span>
                    <span class="tooltip-dim-value">${Math.round(value || 0)}</span>
                </div>
            `).join('');
        }

        function updateExecutionState(execState) {
            const panel = document.getElementById('executionPanel');
            const todosPanel = document.getElementById('todosPanel');

            if (!execState || (!execState.currentPhase && !execState.qualityScores && (!execState.todos || execState.todos.length === 0))) {
                panel.style.display = 'none';
                todosPanel.style.display = 'none';
                return;
            }

            // Show panels
            if (execState.currentPhase || execState.qualityScores) {
                panel.style.display = 'grid';
            }

            // Update phase info
            if (execState.currentPhase) {
                const phase = execState.currentPhase;
                const phaseBadge = document.getElementById('phaseBadge');
                const phaseName = document.getElementById('phaseName');
                const phaseIteration = document.getElementById('phaseIteration');

                phaseBadge.textContent = phase;
                phaseBadge.className = `phase-badge ${phase}`;
                phaseName.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
                phaseIteration.textContent = `Iteration ${execState.phaseIteration || 1} of 10`;
            }

            // Update quality scores
            if (execState.qualityScores) {
                const scores = execState.qualityScores;
                const scoreTotal = document.getElementById('scoreTotal');
                const scoreThreshold = document.getElementById('scoreThreshold');
                const scoreCriteria = document.getElementById('scoreCriteria');

                const total = scores.totalScore || 0;
                const threshold = PHASE_THRESHOLDS[scores.phase] || 80;

                scoreTotal.textContent = total;
                scoreTotal.className = `score-total ${total >= threshold ? 'passing' : total >= threshold - 10 ? 'close' : 'failing'}`;
                scoreThreshold.textContent = `Min: ${threshold}`;

                // Render criteria
                if (scores.scores) {
                    scoreCriteria.innerHTML = Object.entries(scores.scores).map(([name, score]) => {
                        const fillClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
                        return `
                            <div class="score-criterion">
                                <span class="criterion-name">${name}</span>
                                <div class="criterion-bar">
                                    <div class="criterion-fill ${fillClass}" style="width: ${score}%"></div>
                                </div>
                                <span class="criterion-score">${score}</span>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Update phase history
            if (execState.phaseHistory && execState.phaseHistory.length > 0) {
                const historyContainer = document.getElementById('phaseHistory');
                historyContainer.innerHTML = execState.phaseHistory.map((h, i) => {
                    const threshold = PHASE_THRESHOLDS[h.phase] || 80;
                    const isPassing = h.totalScore >= threshold;
                    const isCurrent = i === execState.phaseHistory.length - 1;
                    return `<div class="phase-history-dot ${isCurrent ? 'current' : isPassing ? 'passing' : 'failing'}" title="${h.phase}: ${h.totalScore}"></div>`;
                }).join('');
            }

            // Update todos
            if (execState.todos && execState.todos.length > 0) {
                todosPanel.style.display = 'block';

                const completed = execState.todos.filter(t => t.completed).length;
                const total = execState.todos.length;
                const percent = total > 0 ? (completed / total) * 100 : 0;

                document.getElementById('todosProgressFill').style.width = `${percent}%`;
                document.getElementById('todosProgressText').textContent = `${completed}/${total}`;

                document.getElementById('todosList').innerHTML = execState.todos.map(todo => `
                    <div class="todo-item ${todo.completed ? 'completed' : ''}">
                        <div class="todo-checkbox ${todo.completed ? 'checked' : ''}"></div>
                        <span class="todo-text">${todo.text}</span>
                    </div>
                `).join('');
            } else {
                todosPanel.style.display = 'none';
            }
        }

        function updateBacklogPanel(taskData) {
            const backlogPanel = document.getElementById('backlogPanel');

            if (!taskData) {
                backlogPanel.style.display = 'none';
                return;
            }

            const { inProgress, ready, stats } = taskData;
            const allTasks = [...(inProgress || []), ...(ready || [])];

            if (allTasks.length === 0) {
                backlogPanel.style.display = 'none';
                return;
            }

            backlogPanel.style.display = 'block';

            // Update stats
            document.getElementById('backlogInProgress').textContent = `${(inProgress || []).length} in progress`;
            document.getElementById('backlogReady').textContent = `${(ready || []).length} ready`;

            // Render task list (in_progress first, then ready)
            const backlogList = document.getElementById('backlogList');
            backlogList.innerHTML = allTasks.map(task => `
                <div class="backlog-task ${task.status}">
                    <div class="backlog-task-status"></div>
                    <div class="backlog-task-info">
                        <div class="backlog-task-title">${task.title || task.id}</div>
                        <div class="backlog-task-phase">${task.phase || ''} ${task.estimate ? 'â€¢ ' + task.estimate : ''}</div>
                    </div>
                    <span class="backlog-task-badge">${task.status === 'in_progress' ? 'Running' : 'Ready'}</span>
                </div>
            `).join('');
        }

        function updateDisplay(data) {
            const { projects, sessionSeries, executionState, confidenceState, planComparison, complexity, taskData } = data;

            // Update session series panel
            updateSessionSeries(sessionSeries);

            // Update execution state panel
            updateExecutionState(executionState);

            // Update confidence monitor panel
            updateConfidencePanel(confidenceState);

            // Update competitive planning panel
            updatePlanningPanel(planComparison, complexity);

            // Update backlog tasks panel
            updateBacklogPanel(taskData);

            if (!projects || projects.length === 0) {
                document.getElementById('activeSessionsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <div class="empty-state-text">No projects found</div>
                        <div class="empty-state-sub">Claude Code projects will appear here</div>
                    </div>
                `;
                return;
            }

            // Split active vs inactive
            const active = projects.filter(p => p.status === 'active');
            const inactive = projects.filter(p => p.status !== 'active');

            // Find highest alert level for banner
            let highestAlert = null;
            let highestAlertProject = null;

            // Render active sessions
            const container = document.getElementById('activeSessionsContainer');

            if (active.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¤</div>
                        <div class="empty-state-text">No active sessions</div>
                        <div class="empty-state-sub">Start a Claude Code session to begin monitoring</div>
                    </div>
                `;
            } else {
                container.innerHTML = active.map(project => {
                    const used = project.metrics?.contextPercent || 0;
                    const usedTokens = project.metrics?.contextUsed || 0;
                    // Total remaining = 100% - used%
                    // Free until auto-compact â‰ˆ remaining - 22.5% buffer (but shown as remaining tokens)
                    const totalRemaining = Math.max(0, 100 - used);
                    const remainingTokens = Math.max(0, 200000 - usedTokens);
                    // Tokens until auto-compact (subtracting 45k buffer)
                    const tokensUntilCompact = Math.max(0, remainingTokens - 45000);
                    const statusClass = getStatusClass(used);
                    const safetyStatus = project.safetyStatus || 'OK';

                    // Track highest alert
                    if (safetyStatus === 'EMERGENCY') {
                        highestAlert = 'EMERGENCY';
                        highestAlertProject = project;
                    } else if (safetyStatus === 'CRITICAL' && highestAlert !== 'EMERGENCY') {
                        highestAlert = 'CRITICAL';
                        highestAlertProject = project;
                    } else if (safetyStatus === 'WARNING' && !highestAlert) {
                        highestAlert = 'WARNING';
                        highestAlertProject = project;
                    }

                    return `
                        <div class="session-card ${statusClass !== 'ok' ? statusClass : ''}">
                            <div class="session-header">
                                <div>
                                    <div class="session-name">${project.name}</div>
                                    <div class="session-path">${project.path}</div>
                                </div>
                                <span class="session-status ${statusClass}">${safetyStatus}</span>
                            </div>

                            <div class="remaining-display">
                                <div class="remaining-value ${statusClass}">${totalRemaining.toFixed(0)}%</div>
                                <div class="remaining-label">context remaining</div>
                                <div class="remaining-tokens">${formatTokens(tokensUntilCompact)} until auto-compact</div>
                            </div>

                            <div class="progress-container">
                                <div class="progress-labels">
                                    <span>Used: ${used.toFixed(1)}%</span>
                                    <span>Auto-compact: 77.5%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill ${statusClass}" style="width: ${Math.min(used, 100)}%"></div>
                                    <div class="progress-markers">
                                        <div class="marker" style="left: 50%;" data-label="50%"></div>
                                        <div class="marker" style="left: 65%;" data-label="65%"></div>
                                        <div class="marker" style="left: 75%;" data-label="75%"></div>
                                        <div class="marker" style="left: 77.5%; background: var(--critical);" data-label="âš¡"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="session-actions">
                                <button class="action-btn view-details" onclick="viewProjectDetails('${project.path}')">
                                    View Details
                                </button>
                                ${statusClass !== 'ok' ? `
                                    <button class="action-btn ${statusClass === 'emergency' ? 'danger' : 'primary'}"
                                            onclick="copyCommand('/clear')">
                                        Copy /clear
                                    </button>
                                    <button class="action-btn" onclick="copyCommand('/session-init')">
                                        Copy /session-init
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update alert banner
            const banner = document.getElementById('alertBanner');
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = document.getElementById('alertIcon');

            if (highestAlert === 'EMERGENCY') {
                banner.className = 'alert-banner emergency';
                alertIcon.textContent = 'ðŸš¨';
                alertMessage.textContent = `${highestAlertProject.name}: Only ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining - Run /clear NOW!`;
                if (lastAlertLevel !== 'EMERGENCY') {
                    playAlertSound(1000, 0.2, 5);
                    showNotification('EMERGENCY', `Only ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% context remaining!`);
                }
                lastAlertLevel = 'EMERGENCY';
            } else if (highestAlert === 'CRITICAL') {
                banner.className = 'alert-banner critical';
                alertIcon.textContent = 'âš ï¸';
                alertMessage.textContent = `${highestAlertProject.name}: ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining - Clear soon`;
                if (lastAlertLevel !== 'CRITICAL' && lastAlertLevel !== 'EMERGENCY') {
                    playAlertSound(800, 0.3, 3);
                    showNotification('Critical', `${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% context remaining`);
                }
                lastAlertLevel = 'CRITICAL';
            } else if (highestAlert === 'WARNING') {
                banner.className = 'alert-banner warning';
                alertIcon.textContent = 'âš¡';
                alertMessage.textContent = `${highestAlertProject.name}: ${(100 - highestAlertProject.metrics.contextPercent).toFixed(0)}% remaining`;
                if (!lastAlertLevel) {
                    playAlertSound(600, 0.2, 2);
                }
                lastAlertLevel = 'WARNING';
            } else {
                banner.className = 'alert-banner';
                lastAlertLevel = null;
            }

            // Update inactive section
            const inactiveSection = document.getElementById('inactiveSection');
            const inactiveList = document.getElementById('inactiveList');
            const inactiveCount = document.getElementById('inactiveCount');

            if (inactive.length > 0) {
                inactiveSection.style.display = 'block';
                inactiveCount.textContent = `${inactive.length} inactive project${inactive.length > 1 ? 's' : ''}`;
                inactiveList.innerHTML = inactive.map(p => `
                    <div class="inactive-item">
                        <span class="inactive-name">${p.name}</span>
                        <span class="inactive-time">${timeAgo(p.metrics?.lastUpdate)}</span>
                    </div>
                `).join('');
            } else {
                inactiveSection.style.display = 'none';
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`Claude: ${title}`, { body });
            }
        }

        // ========== SESSION DETAIL VIEW FUNCTIONS ==========

        function showDetailView(sessionId) {
            currentDetailSessionId = sessionId;
            document.getElementById('detailView').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Re-enable pause button for real sessions
            const pauseBtn = document.getElementById('detailPauseBtn');
            pauseBtn.disabled = false;
            pauseBtn.style.opacity = '1';
            pauseBtn.title = '';

            // Fetch and display session details
            fetchSessionDetail(sessionId);

            // Start periodic refresh
            detailRefreshInterval = setInterval(() => {
                if (currentDetailSessionId) {
                    fetchSessionDetail(currentDetailSessionId);
                }
            }, 3000);
        }

        function hideDetailView() {
            currentDetailSessionId = null;
            document.getElementById('detailView').style.display = 'none';
            document.body.style.overflow = 'auto';

            // Stop refresh
            if (detailRefreshInterval) {
                clearInterval(detailRefreshInterval);
                detailRefreshInterval = null;
            }

            // Stop log stream and reset log panel
            stopLogStream();
            const logPanel = document.getElementById('logPanel');
            const logContent = document.getElementById('logContent');
            if (logPanel) {
                logPanel.classList.remove('expanded');
                if (logContent) logContent.style.display = 'none';
            }
            logPaused = false;
            const pauseBtn = document.getElementById('logPauseBtn');
            if (pauseBtn) pauseBtn.classList.remove('paused');
        }

        async function fetchSessionDetail(sessionId) {
            try {
                const response = await fetch(`${API_URL}/api/sessions/${sessionId}`);
                if (!response.ok) {
                    console.error('Session not found');
                    return;
                }
                const session = await response.json();
                updateDetailView(session);
            } catch (err) {
                console.error('Failed to fetch session details:', err);
            }
        }

        function updateDetailView(session) {
            // Project info
            document.getElementById('detailProjectName').textContent = session.project || 'Unknown Project';
            document.getElementById('detailPath').textContent = session.path || '';

            const statusEl = document.getElementById('detailStatus');
            const isPaused = session.status === 'paused';
            statusEl.textContent = isPaused ? 'â—‹ PAUSED' : 'â— RUNNING';
            statusEl.className = `detail-status ${isPaused ? 'paused' : ''}`;

            // Update pause button
            const pauseBtn = document.getElementById('detailPauseBtn');
            pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
            pauseBtn.className = `control-btn pause ${isPaused ? 'paused' : ''}`;

            // Context metrics
            const contextPercent = session.contextPercent || 0;
            const contextUsed = 100 - contextPercent;
            const tokensUsed = Math.round((contextUsed / 100) * 200000);
            const tokensRemaining = 200000 - tokensUsed;
            const tokensUntilCompact = Math.max(0, tokensRemaining - 45000);

            document.getElementById('detailContextPercent').textContent = `${contextPercent.toFixed(0)}%`;
            document.getElementById('detailTokensUsed').textContent = `${formatTokens(tokensUsed)} / 200K tokens`;
            document.getElementById('detailTokensRemaining').textContent = `~${formatTokens(tokensUntilCompact)} until compact`;

            const contextFill = document.getElementById('detailContextFill');
            contextFill.style.width = `${contextUsed}%`;
            contextFill.className = `metric-progress-fill ${getStatusClass(contextUsed)}`;

            // Session metrics
            document.getElementById('detailRuntime').textContent = formatDuration((session.runtime || 0) * 1000);
            document.getElementById('detailIteration').textContent = `Iteration: ${session.iteration || 1} of 10`;
            document.getElementById('detailPhase').textContent = `Phase: ${session.phase || session.currentTask?.phase || 'idle'}`;

            // Cost metrics
            const cost = session.cost || 0;
            const budget = 10.00;
            document.getElementById('detailCost').textContent = `$${cost.toFixed(2)}`;
            document.getElementById('detailCostFill').style.width = `${Math.min(100, (cost / budget) * 100)}%`;
            document.getElementById('detailTokenBreakdown').textContent = `In: ${formatTokens(session.tokensIn || session.tokens || 0)} / Out: ${formatTokens(session.tokensOut || 0)}`;

            // Current task
            const task = session.currentTask || {};
            document.getElementById('detailTaskTitle').textContent = task.title || task.id || 'No active task';
            document.getElementById('detailTaskPhase').textContent = task.phase || 'idle';
            document.getElementById('detailTaskPhase').className = `phase-badge ${task.phase || 'idle'}`;
            document.getElementById('detailTaskPriority').textContent = `Priority: ${task.priority || 'medium'}`;
            document.getElementById('detailTaskEstimate').textContent = `Estimate: ${task.estimate || '--'}`;

            // Acceptance criteria
            const criteria = session.acceptanceCriteria || task.acceptanceCriteria || [];
            renderAcceptanceCriteria(criteria);

            // Quality score
            const qualityScore = session.qualityScore || 0;
            const qualityEl = document.getElementById('detailQualityScore');
            qualityEl.textContent = qualityScore;
            qualityEl.className = `quality-score-value ${qualityScore >= 85 ? '' : qualityScore >= 75 ? 'close' : 'failing'}`;

            // Confidence
            const confidence = session.confidenceScore || session.confidence || 0;
            const circumference = 2 * Math.PI * 32;
            const offset = circumference - (confidence / 100) * circumference;

            document.getElementById('detailConfidenceValue').textContent = Math.round(confidence);
            const confFill = document.getElementById('detailConfidenceFill');
            confFill.style.strokeDashoffset = offset;
            confFill.className = `confidence-mini-fill ${confidence >= 70 ? '' : confidence >= 50 ? 'warning' : 'critical'}`;

            // Confidence signals
            const signals = session.confidenceSignals || {};
            updateDetailSignal('detailSignalQuality', 'detailSignalQualityVal', signals.quality || signals.qualityScore || qualityScore);
            updateDetailSignal('detailSignalVelocity', 'detailSignalVelocityVal', signals.velocity || 50);
            updateDetailSignal('detailSignalIterations', 'detailSignalIterationsVal', signals.iterations || 50);
            updateDetailSignal('detailSignalErrorRate', 'detailSignalErrorRateVal', signals.errorRate || 10);
            updateDetailSignal('detailSignalHistorical', 'detailSignalHistoricalVal', signals.historical || 70);

            // Task queue
            const queue = session.taskQueue || [];
            renderTaskQueue(queue);
        }

        function updateDetailSignal(fillId, valId, value) {
            document.getElementById(fillId).style.width = `${value}%`;
            document.getElementById(valId).textContent = Math.round(value);
        }

        function renderAcceptanceCriteria(criteria) {
            const list = document.getElementById('acceptanceCriteriaList');
            const metCount = criteria.filter(c => c.met).length;
            const total = criteria.length;

            document.getElementById('acceptanceProgress').textContent = `${metCount}/${total}`;
            document.getElementById('acceptanceBarFill').style.width = total > 0 ? `${(metCount / total) * 100}%` : '0%';

            if (criteria.length === 0) {
                list.innerHTML = '<div class="acceptance-item"><span class="acceptance-text" style="color: var(--text-secondary);">No acceptance criteria defined</span></div>';
                return;
            }

            list.innerHTML = criteria.map(c => `
                <div class="acceptance-item ${c.met ? 'met' : ''}">
                    <div class="acceptance-checkbox ${c.met ? 'checked' : ''}"></div>
                    <span class="acceptance-text">${c.text}</span>
                </div>
            `).join('');
        }

        function renderTaskQueue(queue) {
            const tbody = document.getElementById('taskQueueBody');
            document.getElementById('queueCount').textContent = `${queue.length} tasks`;

            if (queue.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No tasks in queue</td></tr>';
                return;
            }

            tbody.innerHTML = queue.map((task, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${task.title || task.id}${i === 0 ? '<span class="next-badge">NEXT</span>' : ''}</td>
                    <td><span class="priority-badge ${task.priority || 'medium'}">${task.priority || 'medium'}</span></td>
                    <td>${task.phase || '--'}</td>
                    <td>${task.estimate || '--'}</td>
                </tr>
            `).join('');
        }

        async function togglePauseSession() {
            if (!currentDetailSessionId) return;

            const session = await fetch(`${API_URL}/api/sessions/${currentDetailSessionId}`).then(r => r.json()).catch(() => null);
            if (!session) return;

            const endpoint = session.status === 'paused' ? 'resume' : 'pause';

            try {
                await fetch(`${API_URL}/api/sessions/${currentDetailSessionId}/${endpoint}`, { method: 'POST' });
                fetchSessionDetail(currentDetailSessionId);
            } catch (err) {
                console.error('Failed to toggle session:', err);
            }
        }

        async function endSession() {
            if (!currentDetailSessionId) return;

            if (!confirm('Are you sure you want to end this session?')) return;

            try {
                await fetch(`${API_URL}/api/sessions/${currentDetailSessionId}/end`, { method: 'POST' });
                hideDetailView();
            } catch (err) {
                console.error('Failed to end session:', err);
            }
        }

        // ============================================================================
        // LOG STREAMING FUNCTIONALITY
        // ============================================================================

        let logEventSource = null;
        let logPaused = false;
        let logLineCount = 0;
        let logErrorCount = 0;
        let logWarnCount = 0;
        let logCurrentFilter = 'all';
        const logMaxLines = 500;

        function toggleLogPanel() {
            const panel = document.getElementById('logPanel');
            const content = document.getElementById('logContent');
            const isExpanded = panel.classList.contains('expanded');

            panel.classList.toggle('expanded');
            content.style.display = isExpanded ? 'none' : 'block';

            if (!isExpanded && currentDetailSessionId) {
                // Panel is being expanded - start log stream
                startLogStream(currentDetailSessionId);
            } else if (isExpanded) {
                // Panel is being collapsed - stop log stream
                stopLogStream();
            }
        }

        function startLogStream(sessionId) {
            // Close any existing stream
            stopLogStream();

            // Reset counts
            logLineCount = 0;
            logErrorCount = 0;
            logWarnCount = 0;
            updateLogCounts();

            // Update status
            updateLogStatus('connecting');
            document.getElementById('logSessionInfo').textContent = `Session: ${sessionId}`;
            document.getElementById('logOutput').innerHTML = '<div class="log-empty-message">Connecting to log stream...</div>';

            // Create SSE connection
            logEventSource = new EventSource(`${API_URL}/api/logs/${sessionId}/stream`);

            logEventSource.addEventListener('connected', (event) => {
                const data = JSON.parse(event.data);
                console.log('[LOG] Connected to stream:', data);
                updateLogStatus('streaming');
                document.getElementById('logOutput').innerHTML = '';
            });

            logEventSource.addEventListener('history', (event) => {
                const data = JSON.parse(event.data);
                console.log('[LOG] Received history:', data.entries?.length, 'entries');
                if (data.entries && data.entries.length > 0) {
                    document.getElementById('logOutput').innerHTML = '';
                    data.entries.forEach(entry => addLogEntry(entry));
                } else {
                    document.getElementById('logOutput').innerHTML = '<div class="log-empty-message">No log entries yet. Waiting for new logs...</div>';
                }
            });

            logEventSource.addEventListener('log', (event) => {
                const entry = JSON.parse(event.data);
                if (!logPaused) {
                    addLogEntry(entry);
                }
            });

            logEventSource.addEventListener('status', (event) => {
                const data = JSON.parse(event.data);
                if (data.paused !== undefined) {
                    updateLogStatus(data.paused ? 'paused' : 'streaming');
                }
            });

            logEventSource.addEventListener('cleared', (event) => {
                clearLogDisplay();
            });

            logEventSource.onerror = (error) => {
                console.error('[LOG] Stream error:', error);
                updateLogStatus('disconnected');
            };
        }

        function stopLogStream() {
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
            updateLogStatus('disconnected');
        }

        function updateLogStatus(status) {
            const dot = document.getElementById('logStreamingDot');
            const text = document.getElementById('logStatusText');

            dot.className = 'log-streaming-dot';

            switch (status) {
                case 'streaming':
                    dot.classList.add('streaming');
                    text.textContent = 'Streaming...';
                    break;
                case 'paused':
                    dot.classList.add('paused');
                    text.textContent = 'Paused';
                    break;
                case 'connecting':
                    text.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                default:
                    dot.classList.add('disconnected');
                    text.textContent = 'Disconnected';
                    break;
            }
        }

        function addLogEntry(entry) {
            const output = document.getElementById('logOutput');
            const autoScroll = document.getElementById('logAutoScroll').checked;
            const filter = document.getElementById('logLevelFilter').value;

            // Remove empty message if present
            const emptyMsg = output.querySelector('.log-empty-message');
            if (emptyMsg) emptyMsg.remove();

            // Check filter
            if (!shouldShowLogEntry(entry.level, filter)) {
                return;
            }

            // Create log entry element
            const entryEl = document.createElement('div');
            entryEl.className = `log-entry ${entry.level}`;
            entryEl.innerHTML = `
                <span class="log-timestamp">${entry.timestamp || ''}</span>
                <span class="log-level ${entry.level}">[${entry.level}]</span>
                <span class="log-message">${escapeHtml(entry.line.replace(/^\d{2}:\d{2}:\d{2}\s*\[?\w+\]?\s*\[?\w+\]?\s*/i, ''))}</span>
            `;

            output.appendChild(entryEl);

            // Update counts
            logLineCount++;
            if (entry.level === 'ERROR') logErrorCount++;
            if (entry.level === 'WARN') logWarnCount++;
            updateLogCounts();

            // Trim old entries
            while (output.children.length > logMaxLines) {
                output.removeChild(output.firstChild);
            }

            // Auto-scroll
            if (autoScroll) {
                output.scrollTop = output.scrollHeight;
            }
        }

        function shouldShowLogEntry(level, filter) {
            if (filter === 'all') return true;

            const levelPriority = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };
            const entryPriority = levelPriority[level] || 1;
            const filterPriority = levelPriority[filter] || 0;

            return entryPriority >= filterPriority;
        }

        function updateLogCounts() {
            document.getElementById('logLineCount').textContent = `Lines: ${logLineCount}`;
            document.getElementById('logErrorCount').textContent = `E: ${logErrorCount}`;
            document.getElementById('logWarnCount').textContent = `W: ${logWarnCount}`;
        }

        function toggleLogPause() {
            logPaused = !logPaused;

            const btn = document.getElementById('logPauseBtn');
            const icon = document.getElementById('logPauseIcon');
            const text = document.getElementById('logPauseText');

            if (logPaused) {
                btn.classList.add('paused');
                icon.textContent = 'â–¶';
                text.textContent = 'Resume';
                updateLogStatus('paused');

                // Notify server
                if (currentDetailSessionId) {
                    fetch(`${API_URL}/api/logs/${currentDetailSessionId}/pause`, { method: 'POST' });
                }
            } else {
                btn.classList.remove('paused');
                icon.textContent = 'â¸';
                text.textContent = 'Pause';
                updateLogStatus('streaming');

                // Notify server
                if (currentDetailSessionId) {
                    fetch(`${API_URL}/api/logs/${currentDetailSessionId}/resume`, { method: 'POST' });
                }
            }
        }

        function clearLogDisplay() {
            const output = document.getElementById('logOutput');
            output.innerHTML = '<div class="log-empty-message">Log cleared. Waiting for new entries...</div>';
            logLineCount = 0;
            logErrorCount = 0;
            logWarnCount = 0;
            updateLogCounts();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ======================================
        // LOG SEARCH FUNCTIONALITY - Phase 4 Polish
        // ======================================

        let searchMatches = [];
        let currentSearchIndex = -1;
        let searchQuery = '';

        function performSearch(query) {
            searchQuery = query.toLowerCase().trim();
            searchMatches = [];
            currentSearchIndex = -1;

            const output = document.getElementById('logOutput');
            const entries = output.querySelectorAll('.log-entry');
            const countEl = document.getElementById('logSearchCount');

            // Clear previous highlights
            entries.forEach(entry => {
                entry.classList.remove('search-match', 'search-current');
                // Restore original text (remove highlights)
                const messageEl = entry.querySelector('.log-message');
                if (messageEl && messageEl.dataset.originalText) {
                    messageEl.textContent = messageEl.dataset.originalText;
                }
            });

            if (!searchQuery) {
                countEl.textContent = '';
                countEl.className = 'log-search-count';
                updateSearchButtons();
                return;
            }

            // Find matches and highlight
            entries.forEach((entry, index) => {
                const messageEl = entry.querySelector('.log-message');
                if (!messageEl) return;

                const text = messageEl.textContent;
                // Store original text if not already stored
                if (!messageEl.dataset.originalText) {
                    messageEl.dataset.originalText = text;
                }

                if (text.toLowerCase().includes(searchQuery)) {
                    searchMatches.push({ entry, index });
                    entry.classList.add('search-match');

                    // Highlight matching text
                    const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
                    messageEl.innerHTML = escapeHtml(text).replace(regex, '<mark class="search-highlight">$1</mark>');
                }
            });

            // Update count display
            if (searchMatches.length > 0) {
                countEl.textContent = `${searchMatches.length} match${searchMatches.length !== 1 ? 'es' : ''}`;
                countEl.className = 'log-search-count has-matches';
                // Jump to first match
                navigateSearch(1);
            } else {
                countEl.textContent = 'No matches';
                countEl.className = 'log-search-count no-matches';
            }

            updateSearchButtons();
        }

        function navigateSearch(direction) {
            if (searchMatches.length === 0) return;

            // Remove current highlight
            if (currentSearchIndex >= 0 && searchMatches[currentSearchIndex]) {
                searchMatches[currentSearchIndex].entry.classList.remove('search-current');
            }

            // Calculate new index
            currentSearchIndex += direction;
            if (currentSearchIndex >= searchMatches.length) {
                currentSearchIndex = 0; // Wrap to start
            } else if (currentSearchIndex < 0) {
                currentSearchIndex = searchMatches.length - 1; // Wrap to end
            }

            // Highlight current match and scroll to it
            const match = searchMatches[currentSearchIndex];
            if (match) {
                match.entry.classList.add('search-current');
                match.entry.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Update count to show position
                const countEl = document.getElementById('logSearchCount');
                countEl.textContent = `${currentSearchIndex + 1}/${searchMatches.length}`;
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('logSearchInput');
            searchInput.value = '';
            performSearch('');
            searchInput.focus();
        }

        function updateSearchButtons() {
            const prevBtn = document.getElementById('logSearchPrev');
            const nextBtn = document.getElementById('logSearchNext');
            const clearBtn = document.getElementById('logSearchClear');

            const hasMatches = searchMatches.length > 0;
            prevBtn.disabled = !hasMatches;
            nextBtn.disabled = !hasMatches;
            clearBtn.style.visibility = searchQuery ? 'visible' : 'hidden';
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Search input event handlers
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('logSearchInput');
            if (searchInput) {
                // Search as you type (with debounce)
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(e.target.value);
                    }, 150);
                });

                // Handle Enter/Shift+Enter for navigation
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            navigateSearch(-1);
                        } else {
                            navigateSearch(1);
                        }
                    } else if (e.key === 'Escape') {
                        clearSearch();
                        searchInput.blur();
                    }
                });
            }

            // Initialize search button visibility
            updateSearchButtons();

            // Initialize history navigation
            initHistoryNavigation();
        });

        // ======================================
        // HISTORICAL NAVIGATION - Phase 4 Polish
        // ======================================

        let isLiveMode = true;
        let currentLogOffset = 0;
        const logsPerPage = 100;
        let oldestTimestamp = null;
        let newestTimestamp = null;

        function initHistoryNavigation() {
            // Set default time to now
            const jumpTimeInput = document.getElementById('logJumpTime');
            if (jumpTimeInput) {
                const now = new Date();
                // Format for datetime-local: YYYY-MM-DDTHH:mm
                jumpTimeInput.value = now.toISOString().slice(0, 16);
            }
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            const olderBtn = document.getElementById('logOlderBtn');
            const newerBtn = document.getElementById('logNewerBtn');
            const latestBtn = document.querySelector('.log-nav-btn[onclick="jumpToLatest()"]');

            if (olderBtn) olderBtn.disabled = false; // Always can load older
            if (newerBtn) newerBtn.disabled = isLiveMode; // Can't go newer in live mode
            if (latestBtn) {
                if (isLiveMode) {
                    latestBtn.classList.add('active');
                } else {
                    latestBtn.classList.remove('active');
                }
            }
        }

        function updateTimeRange() {
            const rangeEl = document.getElementById('logTimeRange');
            if (!rangeEl) return;

            if (isLiveMode) {
                rangeEl.textContent = 'Live';
            } else if (oldestTimestamp && newestTimestamp) {
                const formatTime = (ts) => {
                    const d = new Date(ts);
                    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                };
                rangeEl.textContent = `${formatTime(oldestTimestamp)} - ${formatTime(newestTimestamp)}`;
            } else {
                rangeEl.textContent = 'Historical';
            }
        }

        async function loadOlderLogs() {
            if (!currentDetailSessionId) return;

            isLiveMode = false;
            currentLogOffset += logsPerPage;

            // Pause streaming when viewing history
            if (!logPaused) {
                toggleLogPause();
            }

            try {
                const response = await fetch(
                    `${API_URL}/api/logs/${currentDetailSessionId}/history?lines=${logsPerPage}&offset=${currentLogOffset}`
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.entries && data.entries.length > 0) {
                        displayHistoricalLogs(data.entries, 'prepend');
                        oldestTimestamp = data.entries[0].timestamp || oldestTimestamp;
                    }
                }
            } catch (err) {
                console.error('Failed to load older logs:', err);
            }

            updateHistoryButtons();
            updateTimeRange();
        }

        async function loadNewerLogs() {
            if (!currentDetailSessionId || currentLogOffset <= 0) return;

            currentLogOffset = Math.max(0, currentLogOffset - logsPerPage);

            if (currentLogOffset === 0) {
                // Back to live mode
                jumpToLatest();
                return;
            }

            try {
                const response = await fetch(
                    `${API_URL}/api/logs/${currentDetailSessionId}/history?lines=${logsPerPage}&offset=${currentLogOffset}`
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.entries && data.entries.length > 0) {
                        displayHistoricalLogs(data.entries, 'replace');
                        newestTimestamp = data.entries[data.entries.length - 1].timestamp || newestTimestamp;
                    }
                }
            } catch (err) {
                console.error('Failed to load newer logs:', err);
            }

            updateHistoryButtons();
            updateTimeRange();
        }

        async function jumpToTime() {
            const jumpTimeInput = document.getElementById('logJumpTime');
            if (!jumpTimeInput || !currentDetailSessionId) return;

            const targetTime = new Date(jumpTimeInput.value);
            if (isNaN(targetTime.getTime())) {
                alert('Please enter a valid date and time');
                return;
            }

            isLiveMode = false;

            // Pause streaming
            if (!logPaused) {
                toggleLogPause();
            }

            try {
                const response = await fetch(
                    `${API_URL}/api/logs/${currentDetailSessionId}/history?lines=${logsPerPage}&before=${targetTime.toISOString()}`
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.entries && data.entries.length > 0) {
                        displayHistoricalLogs(data.entries, 'replace');
                        oldestTimestamp = data.entries[0].timestamp;
                        newestTimestamp = data.entries[data.entries.length - 1].timestamp;
                    } else {
                        const output = document.getElementById('logOutput');
                        output.innerHTML = '<div class="log-empty-message">No logs found for this time period</div>';
                    }
                }
            } catch (err) {
                console.error('Failed to jump to time:', err);
            }

            updateHistoryButtons();
            updateTimeRange();
        }

        function jumpToLatest() {
            isLiveMode = true;
            currentLogOffset = 0;
            oldestTimestamp = null;
            newestTimestamp = null;

            // Resume streaming if paused
            if (logPaused) {
                toggleLogPause();
            }

            // Clear and reconnect to live stream
            const output = document.getElementById('logOutput');
            output.innerHTML = '<div class="log-empty-message">Reconnecting to live stream...</div>';
            logLineCount = 0;
            logErrorCount = 0;
            logWarnCount = 0;
            updateLogCounts();

            // Reconnect to log stream
            if (logEventSource) {
                logEventSource.close();
            }
            connectToLogStream(currentDetailSessionId);

            updateHistoryButtons();
            updateTimeRange();
        }

        function displayHistoricalLogs(entries, mode = 'replace') {
            const output = document.getElementById('logOutput');

            // Remove empty message
            const emptyMsg = output.querySelector('.log-empty-message');
            if (emptyMsg) emptyMsg.remove();

            if (mode === 'replace') {
                output.innerHTML = '';
                logLineCount = 0;
                logErrorCount = 0;
                logWarnCount = 0;
            }

            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = `log-entry ${entry.level || 'INFO'}`;

                const timestamp = entry.timestamp
                    ? new Date(entry.timestamp).toLocaleTimeString()
                    : '';

                div.innerHTML = `
                    <span class="log-timestamp">${escapeHtml(timestamp)}</span>
                    <span class="log-level ${entry.level || 'INFO'}">${entry.level || 'INFO'}</span>
                    <span class="log-message">${escapeHtml(entry.line || entry.raw || '')}</span>
                `;

                if (mode === 'prepend') {
                    output.insertBefore(div, output.firstChild);
                } else {
                    output.appendChild(div);
                }

                logLineCount++;
                if (entry.level === 'ERROR') logErrorCount++;
                if (entry.level === 'WARN') logWarnCount++;
            });

            updateLogCounts();

            // Re-apply search if active
            if (searchQuery) {
                performSearch(searchQuery);
            }
        }

        // Filter change handler
        document.addEventListener('DOMContentLoaded', () => {
            const filterSelect = document.getElementById('logLevelFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', () => {
                    logCurrentFilter = filterSelect.value;
                    // Re-filter would require keeping all entries in memory
                    // For simplicity, filter only applies to new entries
                });
            }
        });

        // ============================================================================
        // END LOG STREAMING FUNCTIONALITY
        // ============================================================================

        // Navigate from session card to detail view
        function viewSessionDetails(sessionId) {
            showDetailView(sessionId);
        }

        // View details for a project (by path)
        async function viewProjectDetails(projectPath) {
            try {
                // Try to find a registered session for this project
                const response = await fetch(`${API_URL}/api/sessions/summary`);
                const data = await response.json();

                // Find session matching the project path
                const session = data.sessions?.find(s => s.path === projectPath || s.project === projectPath);

                if (session) {
                    showDetailView(session.id);
                } else {
                    // No registered session - create a temporary view with project info
                    const projectResponse = await fetch(`${API_URL}/api/projects/${encodeURIComponent(projectPath.split('/').pop() || projectPath.split('\\').pop())}`);
                    if (projectResponse.ok) {
                        const project = await projectResponse.json();
                        showProjectDetailFallback(project, projectPath);
                    } else {
                        alert('Session details not available. The orchestrator may not be running for this project.');
                    }
                }
            } catch (err) {
                console.error('Failed to fetch project details:', err);
                alert('Failed to load session details.');
            }
        }

        // Fallback: Show project info when no session is registered
        function showProjectDetailFallback(project, projectPath) {
            // Create a mock session object from project data
            const mockSession = {
                id: null,
                project: project.name || 'Unknown Project',
                path: projectPath,
                status: 'idle',
                contextPercent: project.metrics?.contextPercent || 0,
                tokens: project.metrics?.totalTokens || 0,
                tokensIn: project.metrics?.inputTokens || 0,
                tokensOut: project.metrics?.outputTokens || 0,
                cost: project.metrics?.cost || 0,
                runtime: 0,
                iteration: 0,
                qualityScore: 0,
                confidenceScore: 100,
                currentTask: null,
                acceptanceCriteria: [],
                taskQueue: []
            };

            currentDetailSessionId = null; // Mark as non-session view
            document.getElementById('detailView').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Disable pause/resume for non-session view
            const pauseBtn = document.getElementById('detailPauseBtn');
            pauseBtn.disabled = true;
            pauseBtn.style.opacity = '0.5';
            pauseBtn.title = 'No active session';

            updateDetailView(mockSession);
        }

        function connect() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Initialize Command Center components
            startGlobalMetricsRefresh();
            startUsageLimitsRefresh();

            eventSource = new EventSource(`${API_URL}/api/events`);

            eventSource.onopen = () => {
                document.getElementById('statusDot').classList.remove('disconnected');
                console.log('Connected to global tracker');
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                    // Also update global metrics from SSE data if available
                    if (data.globalMetrics) {
                        updateGlobalMetricsUI({ globalMetrics: data.globalMetrics, sessions: data.projects || [] });
                    }
                    if (data.recentCompletions) {
                        updateRecentCompletions(data.recentCompletions);
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            eventSource.onerror = () => {
                document.getElementById('statusDot').classList.add('disconnected');
                eventSource.close();
                setTimeout(connect, 3000);
            };
        }

        // Sound toggle
        document.getElementById('soundEnabled').addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
        });

        // ======================================
        // KEYBOARD NAVIGATION - Phase 4 Polish
        // ======================================

        let selectedCardIndex = -1;

        function getSessionCards() {
            return Array.from(document.querySelectorAll('#activeSessionsContainer .session-card'));
        }

        function updateCardFocus(newIndex) {
            const cards = getSessionCards();
            if (cards.length === 0) return;

            // Remove focus from all cards
            cards.forEach(card => card.classList.remove('keyboard-focus'));

            // Clamp index to valid range
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= cards.length) newIndex = cards.length - 1;

            selectedCardIndex = newIndex;

            // Add focus to selected card
            if (cards[selectedCardIndex]) {
                cards[selectedCardIndex].classList.add('keyboard-focus');
                cards[selectedCardIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function showShortcutsModal() {
            document.getElementById('shortcutsModal').style.display = 'flex';
        }

        function hideShortcutsModal() {
            document.getElementById('shortcutsModal').style.display = 'none';
        }

        function isInputFocused() {
            const active = document.activeElement;
            return active && (
                active.tagName === 'INPUT' ||
                active.tagName === 'TEXTAREA' ||
                active.tagName === 'SELECT' ||
                active.isContentEditable
            );
        }

        function isModalOpen() {
            const shortcutsModal = document.getElementById('shortcutsModal');
            const detailView = document.getElementById('detailView');
            return (shortcutsModal && shortcutsModal.style.display !== 'none') ||
                   (detailView && detailView.style.display !== 'none');
        }

        function isDetailViewOpen() {
            const detailView = document.getElementById('detailView');
            return detailView && detailView.style.display !== 'none';
        }

        function isShortcutsModalOpen() {
            const shortcutsModal = document.getElementById('shortcutsModal');
            return shortcutsModal && shortcutsModal.style.display !== 'none';
        }

        // Keyboard event handler
        document.addEventListener('keydown', (e) => {
            // Skip if typing in an input field
            if (isInputFocused()) {
                // Allow Escape to blur input
                if (e.key === 'Escape') {
                    document.activeElement.blur();
                    e.preventDefault();
                }
                return;
            }

            const key = e.key.toLowerCase();

            // Escape - close modals/views
            if (e.key === 'Escape') {
                if (isShortcutsModalOpen()) {
                    hideShortcutsModal();
                    e.preventDefault();
                } else if (isDetailViewOpen()) {
                    hideDetailView();
                    e.preventDefault();
                }
                return;
            }

            // ? - show shortcuts modal
            if (key === '?' || (e.shiftKey && key === '/')) {
                showShortcutsModal();
                e.preventDefault();
                return;
            }

            // Commands that work in detail view
            if (isDetailViewOpen()) {
                switch (key) {
                    case 'p':
                        // Pause/Resume log stream
                        if (typeof toggleLogPause === 'function') {
                            toggleLogPause();
                        }
                        e.preventDefault();
                        break;
                    case 'c':
                        // Clear log display
                        if (typeof clearLogDisplay === 'function') {
                            clearLogDisplay();
                        }
                        e.preventDefault();
                        break;
                    case 'a':
                        // Toggle auto-scroll
                        const autoScrollCheckbox = document.getElementById('logAutoScroll');
                        if (autoScrollCheckbox) {
                            autoScrollCheckbox.checked = !autoScrollCheckbox.checked;
                        }
                        e.preventDefault();
                        break;
                    case '/':
                        // Focus search input (will be added in search feature)
                        const searchInput = document.getElementById('logSearchInput');
                        if (searchInput) {
                            searchInput.focus();
                            e.preventDefault();
                        }
                        break;
                }
                return;
            }

            // Commands for main view (Command Center)
            if (!isModalOpen()) {
                const cards = getSessionCards();

                switch (key) {
                    case 'j':
                    case 'arrowdown':
                        // Next card
                        updateCardFocus(selectedCardIndex + 1);
                        e.preventDefault();
                        break;
                    case 'k':
                    case 'arrowup':
                        // Previous card
                        updateCardFocus(selectedCardIndex - 1);
                        e.preventDefault();
                        break;
                    case 'enter':
                        // Open selected session
                        if (selectedCardIndex >= 0 && cards[selectedCardIndex]) {
                            const viewBtn = cards[selectedCardIndex].querySelector('.view-details');
                            if (viewBtn) {
                                viewBtn.click();
                            }
                        }
                        e.preventDefault();
                        break;
                }
            }
        });

        // Reset card selection when cards are updated
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function(data) {
            originalUpdateDisplay(data);
            // Maintain selection if possible, otherwise reset
            const cards = getSessionCards();
            if (selectedCardIndex >= cards.length) {
                selectedCardIndex = cards.length - 1;
            }
            if (selectedCardIndex >= 0 && cards[selectedCardIndex]) {
                cards[selectedCardIndex].classList.add('keyboard-focus');
            }
        };

        // Initial connection
        connect();
    </script>
</body>
</html>
