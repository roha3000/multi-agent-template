<!DOCTYPE html>
<html>
<head>
    <title>Test Dashboard</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #fff; }
        .session { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .metric { display: inline-block; margin: 0 20px 10px 0; }
        .label { color: #888; font-size: 12px; }
        .value { font-size: 24px; font-weight: bold; }
        .progress { width: 100%; height: 30px; background: #333; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722); transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>OTLP Dashboard - Test View</h1>
    <div id="status">Loading...</div>
    <div id="metrics"></div>
    <div id="sessions"></div>

    <script>
        async function fetchData() {
            try {
                const [sessions, metrics] = await Promise.all([
                    fetch('http://localhost:3032/api/sessions').then(r => r.json()),
                    fetch('http://localhost:3032/api/metrics').then(r => r.json())
                ]);

                // Display metrics
                document.getElementById('metrics').innerHTML = `
                    <div class="metric">
                        <div class="label">Total Tokens</div>
                        <div class="value">${(metrics.totalTokensUsed || 0).toLocaleString()}</div>
                    </div>
                    <div class="metric">
                        <div class="label">Active Sessions</div>
                        <div class="value">${metrics.activeSessions || 0}</div>
                    </div>
                    <div class="metric">
                        <div class="label">Total Projects</div>
                        <div class="value">${metrics.totalProjects || 0}</div>
                    </div>
                `;

                // Display sessions
                const sessionsHtml = sessions.map(session => {
                    const percentage = (session.tokensUsed / session.maxTokens) * 100;
                    return `
                        <div class="session">
                            <h3>Session: ${session.sessionId}</h3>
                            <div class="metric">
                                <div class="label">Model</div>
                                <div class="value">${session.model}</div>
                            </div>
                            <div class="metric">
                                <div class="label">Status</div>
                                <div class="value">${session.status}</div>
                            </div>
                            <div class="metric">
                                <div class="label">Context Usage</div>
                                <div class="value">${session.contextUsage.toFixed(1)}%</div>
                            </div>
                            <div class="metric">
                                <div class="label">Tokens</div>
                                <div class="value">${session.tokensUsed.toLocaleString()} / ${session.maxTokens.toLocaleString()}</div>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div style="margin-top: 10px;">
                                <div class="label">Current Task</div>
                                <div>${typeof session.executionPlan === 'object' ? session.executionPlan.current : session.executionPlan}</div>
                            </div>
                            ${session.executionPlan && session.executionPlan.completed ? `
                                <div style="margin-top: 10px;">
                                    <div class="label">Completed Tasks</div>
                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                        ${session.executionPlan.completed.map(task => `<li>${task}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${session.project ? `
                                <div style="margin-top: 10px;">
                                    <div class="label">Project: ${session.project.name}</div>
                                    <div style="margin-top: 5px;">${session.project.description}</div>
                                    <div style="margin-top: 10px;">
                                        <div class="label">Components</div>
                                        ${Object.entries(session.project.components).map(([k,v]) =>
                                            `<div>â€¢ ${k}: ${v}</div>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px;">
                                <div class="label">Checkpoint Status</div>
                                <div>${session.checkpointStatus}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('sessions').innerHTML = sessionsHtml;
                document.getElementById('status').innerHTML = 'Connected - Data updating every 2 seconds';

            } catch (error) {
                document.getElementById('status').innerHTML = 'Error: ' + error.message;
                console.error('Error fetching data:', error);
            }
        }

        // Initial fetch
        fetchData();

        // Update every 2 seconds
        setInterval(fetchData, 2000);

        // SSE for real-time updates
        const eventSource = new EventSource('http://localhost:3032/api/events');
        eventSource.onmessage = function(event) {
            console.log('SSE Update:', event.data);
            fetchData();
        };
    </script>
</body>
</html>