name: Weekly Codebase Audit

on:
  schedule:
    # Run every Sunday at 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      scope:
        description: 'Audit scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - code
          - docs
          - deps
      auto_fix:
        description: 'Apply automatic fixes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Dead Code Analysis
        id: dead_code
        run: |
          node scripts/audit/dead-code-analysis.js > /tmp/dead-code.json 2>&1 || true
          echo "result=$(cat /tmp/dead-code.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Run Duplication Detection
        id: duplicates
        run: |
          node scripts/audit/duplication-detection.js > /tmp/duplicates.json 2>&1 || true
          echo "result=$(cat /tmp/duplicates.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Run Database Inspection
        id: databases
        run: |
          node scripts/audit/database-inspection.js > /tmp/databases.json 2>&1 || true
          echo "result=$(cat /tmp/databases.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Run Documentation Review
        id: docs
        run: |
          node scripts/audit/documentation-review.js > /tmp/docs.json 2>&1 || true
          echo "result=$(cat /tmp/docs.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Run Dependency Analysis
        id: deps
        run: |
          npm audit --json > /tmp/npm-audit.json 2>&1 || true
          npx depcheck --json > /tmp/depcheck.json 2>&1 || true
          node scripts/audit/dependency-analysis.js > /tmp/deps.json 2>&1 || true
          echo "result=$(cat /tmp/deps.json | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Generate Audit Report
        run: |
          node scripts/audit/generate-report.js \
            --dead-code=/tmp/dead-code.json \
            --duplicates=/tmp/duplicates.json \
            --databases=/tmp/databases.json \
            --docs=/tmp/docs.json \
            --deps=/tmp/deps.json \
            --output=docs/audits/AUDIT-REPORT-$(date +%Y-%m-%d).md

      - name: Apply Auto-Fixes
        if: ${{ github.event.inputs.auto_fix == 'true' }}
        run: |
          # Delete orphaned test databases
          find . -path "./__tests__/**/*.db" -delete 2>/dev/null || true
          find . -path "./.claude/memory/test*.db" -delete 2>/dev/null || true

          # Remove unused dependencies (if safe)
          # npm uninstall $(cat /tmp/depcheck.json | jq -r '.dependencies[]') 2>/dev/null || true

          echo "Auto-fixes applied"

      - name: Update tasks.json with cleanup tasks
        run: |
          node scripts/audit/update-tasks.js \
            --report=docs/audits/AUDIT-REPORT-$(date +%Y-%m-%d).md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: Weekly codebase audit - ${{ github.run_number }}'
          title: '[Audit] Weekly Codebase Audit - Issues Found'
          body: |
            ## Weekly Codebase Audit Results

            This PR contains the results of the automated weekly codebase audit.

            ### Summary
            See the full report in `docs/audits/AUDIT-REPORT-*.md`

            ### Cleanup Tasks Added
            New cleanup tasks have been added to `.claude/dev-docs/tasks.json`

            ### Auto-Fixes Applied
            ${{ github.event.inputs.auto_fix == 'true' && 'Yes - Safe automatic fixes were applied' || 'No - Review required' }}

            ---
            Generated by [Weekly Audit Workflow](.github/workflows/weekly-audit.yml)
          branch: audit/weekly-${{ github.run_number }}
          delete-branch: true
          labels: |
            audit
            maintenance
            automated
